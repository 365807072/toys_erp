<?php
class ToysAction extends Action{
    //在类初始化方法中，引入相关类库    
    /*public function _initialize() {
        vendor('Video.Videourlparser');
    }*/
    /**
     * 验证是否已设置session
     */
    //卡
    public function getCardInfo() {
        $str_card="418,420,422,424,548,649,652,655,1040,1041,1137,1139,1253,1255,1336,1338,1340,1342,1416,1625,1627,1629,1631,2253,2255,2633,2635,2853,2902,2907,2914,2916";
        return $str_card;
    }
    //玩具编号数量
    public function getBusinessTotalNum($business_id) {
        $this->checkSession();
        $model = new Model();
        //总库存
        $total_count=$model->table('baby_toys_business_listing')
            ->where(" new_old='0' and state='0' and business_id='$business_id' ")
            ->count();
        //可用编号
        $use1_count=$model->table('baby_toys_business_listing')
            ->where("  state='0' and business_id='$business_id' and is_use in ('0','5') and out_state='0' ")   //new_old='0' and
            ->count();
        //没选编号订单
        $use2_count=$model->table('baby_toys_order')
            ->where("state='0' and business_id=$business_id and (toys_number='' or toys_number is null ) and status in (1,2) and is_prize in (0,3) ")
            ->count();
        //可用库存
        $use_count = $use1_count - $use2_count;

        $new_old_count=$model->table('baby_toys_business_listing')
            ->where(" new_old='2' and state='0' and business_id='$business_id'  ") //and is_use in ('0','5') and out_state='0'
            ->count();
        $use_count = $use_count - $new_old_count;

        $num = array(
            'total_count' => $total_count,
            'use_count' => $use_count
        );
        return $num;
    }
    //玩具电池信息
    public function returnBatteryInfo($combined_order_id,$symbol,$battery_brand,$user_id) {
        $MyRes="";
        $this->checkSession();
        $battery_title="";
        $model = new Model();
        $getBrandRes=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where("o.combined_order_id='$combined_order_id' and o.user_id=$user_id and o.state='0' and o.is_prize='0' and ((b.battery_number5>0) or (b.battery_number7>0)) and ( (b.battery_number5>0) or (b.battery_number7>0) ) and ( (b.business_brand like '%汇乐%') or (b.business_brand like '%谷雨%') ) ")
                    ->field("SUM(b.battery_number5) as battery_number5,SUM(b.battery_number7) as battery_number7")
                    ->find();
        $special5=$getBrandRes['battery_number5'];
        $special7=$getBrandRes['battery_number7'];
        if($battery_brand==1) {
            $getBrandRes2=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where("o.combined_order_id='$combined_order_id' and o.user_id=$user_id and o.state='0' and o.is_prize='0' and ((b.battery_number5>0) or (b.battery_number7>0)) and ( (b.battery_number5>0) or (b.battery_number7>0) ) ")
                    ->field("SUM(b.battery_number5) as battery_number5,SUM(b.battery_number7) as battery_number7")
                    ->find();
            $special5_2=$getBrandRes2['battery_number5'];
            $special7_2=$getBrandRes2['battery_number7'];
            if($special5_2 && $special5) {
                $battery_title5=" 5号电池".$special5_2."节";
                $getBatteryPriceRes5=$this->GetBatteryPriceTotal(5,$battery_brand,$special5_2);
                $battery_price5=$getBatteryPriceRes5['price'];
            } else {
                $battery_title5="";
                $battery_price5=0;
            }
            if($special7_2 && $special7) {
                $battery_title7=" 7号电池".$special7_2."节";
                $getBatteryPriceRes7=$this->GetBatteryPriceTotal(7,$battery_brand,$special7_2);
                $battery_price7=$getBatteryPriceRes7['price'];
            } else {
                $battery_title7="";
                $battery_price7=0;
            }
            $battery_title.="【华太电池】：";
            $tmp_battery_price=$battery_price5+$battery_price7;
            if($special5_2 && $special5) {
                $battery_title.=$battery_title5.",";
            }
            if($special7_2 && $special7 ) {
                $battery_title.=$battery_title7.",";
            }
            $battery_title.=" 共".$tmp_battery_price."元";
            $MyRes.=$symbol.$battery_title; 
        } else {
            $getBatRes=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where("o.combined_order_id='$combined_order_id' and o.user_id=$user_id and o.state='0' and o.is_prize='0' and ((b.battery_number1>0) or (b.battery_number2>0) or (b.battery_number3>0) or (b.battery_number4>0) or (b.battery_number5>0) or (b.battery_number6>0) or (b.battery_number7>0) or (b.battery_number8>0) )")
                    ->field("SUM(b.battery_number1) as battery_number1,SUM(b.battery_number2) as battery_number2,SUM(b.battery_number3) as battery_number3,SUM(b.battery_number4) as battery_number4,SUM(b.battery_number5) as battery_number5,SUM(b.battery_number6) as battery_number6,SUM(b.battery_number7) as battery_number7,SUM(b.battery_number8) as battery_number8,o.create_time")
                    ->find();
            if($getBatRes) {
                $battery_number1=$getBatRes['battery_number1'];
                $battery_number2=$getBatRes['battery_number2'];
                $battery_number3=$getBatRes['battery_number3'];
                $battery_number4=$getBatRes['battery_number4'];
                $battery_number5=$getBatRes['battery_number5'];
                $battery_number6=$getBatRes['battery_number6'];
                $battery_number7=$getBatRes['battery_number7'];
                $battery_number8=$getBatRes['battery_number8'];
                $show_create_time=$getBatRes['create_time'];
                if($battery_number1>0) {
                    $battery_title1=" 1号电池".$battery_number1."节";
                    $getBatteryPriceRes1=$this->GetBatteryPriceTotal(1,$battery_brand,$battery_number1);
                    $battery_price1=$getBatteryPriceRes1['price'];
                } else {
                    $battery_title1="";
                    $battery_price1=0; 
                }
                if($battery_number2>0) {
                    $battery_title2=" 2号电池".$battery_number2."节";
                    $getBatteryPriceRes2=$this->GetBatteryPriceTotal(2,$battery_brand,$battery_number2);
                    $battery_price2=$getBatteryPriceRes2['price'];
                } else {
                    $battery_title2="";
                    $battery_price2=0;
                }
                if($battery_number3>0) {
                    $battery_title3=" 3号电池".$battery_number3."节";
                    $getBatteryPriceRes3=$this->GetBatteryPriceTotal(3,$battery_brand,$battery_number3);
                    $battery_price3=$getBatteryPriceRes3['price'];
                } else {
                    $battery_title3="";
                    $battery_price3=0;
                }
                if($battery_number4>0) {
                    $battery_title4=" 4号电池".$battery_number4."节";
                    $getBatteryPriceRes4=$this->GetBatteryPriceTotal(4,$battery_brand,$battery_number4);
                    $battery_price4=$getBatteryPriceRes4['price'];
                } else {
                    $battery_title4="";
                    $battery_price4=0; 
                }
                if($battery_number5>0 && ( $show_create_time<'2017-10-27 18:20:00' || (empty($special5) && $show_create_time>'2017-10-27 18:20:00' ) ) ) {
                    $battery_title5=" 5号电池".$battery_number5."节";
                    $getBatteryPriceRes5=$this->GetBatteryPriceTotal(5,$battery_brand,$battery_number5);
                    $battery_price5=$getBatteryPriceRes5['price'];
                } else {
                    $battery_title5="";
                    $battery_price5=0;
                }
                if($battery_number6>0) {
                    $battery_title6=" 6号电池".$battery_number6."节";
                    $getBatteryPriceRes6=$this->GetBatteryPriceTotal(6,$battery_brand,$battery_number6);
                    $battery_price6=$getBatteryPriceRes6['price'];
                } else {
                    $battery_title6="";
                    $battery_price6=0;
                }
                if($battery_number7>0 && ( $show_create_time<'2017-10-27 18:20:00' || (empty($special7) && $show_create_time>'2017-10-27 18:20:00' ) ) ) {
                    $battery_title7=" 7号电池".$battery_number7."节";
                    $getBatteryPriceRes7=$this->GetBatteryPriceTotal(7,$battery_brand,$battery_number7);
                    $battery_price7=$getBatteryPriceRes7['price'];
                } else {
                    $battery_title7="";
                    $battery_price7=0;
                }
                if($battery_number8>0) {
                    $battery_title8=" 纽扣电池".$battery_number8."节";
                    $getBatteryPriceRes8=$this->GetBatteryPriceTotal(8,$battery_brand,$battery_number8);
                    $battery_price8=$getBatteryPriceRes8['price'];
                } else {
                    $battery_title8="";
                    $battery_price8=0;
                }
                $battery_title.="【南孚电池】：";
                $tmp_battery_price=$battery_price1+$battery_price2+$battery_price3+$battery_price4+$battery_price5+$battery_price6+$battery_price7+$battery_price8;
                if($battery_title1) {
                    $battery_title.=$battery_title1.",";
                }
                if($battery_title2) {
                    $battery_title.=$battery_title2.",";
                }
                if($battery_title3) {
                    $battery_title.=$battery_title3.",";
                }
                if($battery_title4) {
                    $battery_title.=$battery_title4.",";
                }
                if($battery_title5 && ( $show_create_time<'2017-10-27 18:20:00' || (empty($special5) && $show_create_time>'2017-10-27 18:20:00' ) ) ) {
                    $battery_title.=$battery_title5.",";
                }
                if($battery_title6) {
                    $battery_title.=$battery_title6.",";
                }
                if($battery_title7 && ( $show_create_time<'2017-10-27 18:20:00' || (empty($special7) && $show_create_time>'2017-10-27 18:20:00' ) ) ) {
                    $battery_title.=$battery_title7.",";
                }
                if($battery_title8) {
                    $battery_title.=$battery_title8.",";
                }
                $battery_title.=" 共".$tmp_battery_price."元";
                $MyRes.=$symbol.$battery_title; 
            }
        }
        return $MyRes;
    }


    //电池单价
    static public function GetBatteryPriceTotal($type,$brand,$number){
        $imgRes=array();
        $getorderRes= M("toys_battery")
                    ->where("state='0' and type='$type' and brand='$brand'")
                    ->field("price")
                    ->find();
        $getorderPrice=$getorderRes['price'];
        if($getorderPrice) {
            $imgRes['price']=$getorderPrice*$number;
        } else {
            $imgRes['price']=2*$number;
        }
        return $imgRes;
    }
    //导出方法
    public function exportExcel($expTitle,$expCellName,$expTableData){
        ob_clean();
        $xlsTitle = iconv('utf-8', 'gb2312', $expTitle);//文件名称
        $fileName = $xlsTitle.date('_mdHis');
        //$fileName = $_SESSION['loginAccount'].date('_YmdHis');//or $xlsTitle 文件名称可根据自己情况设定
        $cellNum = count($expCellName);
        $dataNum = count($expTableData);
        vendor("PHPExcel.PHPExcel");
        $objPHPExcel = new PHPExcel();
        $cellName = array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','AA','AB','AC','AD','AE','AF','AG','AH','AI','AJ','AK','AL','AM','AN','AO','AP','AQ','AR','AS','AT','AU','AV','AW','AX','AY','AZ');
        $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setAutoSize(true);
        $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setAutoSize(true);
        $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setAutoSize(true);
        $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setAutoSize(true);
        $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setAutoSize(true);
       /*$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setAutoSize(true);
       $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setAutoSize(true);*/
        $objPHPExcel->getActiveSheet()->getStyle('A4')->getBorders()->getTop()->setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);

        for($i=0;$i<$cellNum;$i++){
            $objPHPExcel->getActiveSheet()->getStyle('A'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('B'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('C'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('D'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('E'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('F'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
            $objPHPExcel->getActiveSheet()->getStyle('G'.'2')->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);

           /*$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
           $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(15);
           $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(5);
           $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(20);
           $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(20);*/
            $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(10);
            $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(20);
            //水平居中
            $objPHPExcel->getActiveSheet()->getStyle($cellName[$i].'2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
            $objPHPExcel->getActiveSheet()->getStyle($cellName[$i].'2')->getAlignment()->setWrapText(true);  
            //垂直居中
            $objPHPExcel->getActiveSheet()->getStyle($cellName[$i].'2')->getAlignment()->setVertical(PHPExcel_Style_Alignment::VERTICAL_CENTER);
            $objPHPExcel->getActiveSheet()->getStyle($cellName[$i].'2')->getFont()->setName('宋体')->setSize(14)->setBold(true);
            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($cellName[$i].'2', $expCellName[$i][1]); 
        }   
        for($i=0;$i<$dataNum;$i++){
            for($j=0;$j<$cellNum;$j++){
                $objPHPExcel->getActiveSheet()->getStyle('A'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('B'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('C'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('D'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('E'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('F'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
                $objPHPExcel->getActiveSheet()->getStyle('G'.($i+3))->getBorders()->getAllBorders()->setBorderStyle(\PHPExcel_Style_Border::BORDER_THIN);
               /*$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
               $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(15);
               $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(5);*/
               $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(10);
               $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(10);
                $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(10);
                $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(20);
                if($j==2 || $j==3 || $j==4 || $j==5 || $j==6) {
                    $objPHPExcel->getActiveSheet()->getStyle($cellName[$j].($i+3))->getAlignment()->setVertical(\PHPExcel_Style_Alignment::HORIZONTAL_JUSTIFY);
                } else {
                    //水平居中
                    $objPHPExcel->getActiveSheet()->getStyle($cellName[$j].($i+3))->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
                    //垂直居中
                    $objPHPExcel->getActiveSheet()->getStyle($cellName[$j].($i+3))->getAlignment()->setVertical(PHPExcel_Style_Alignment::VERTICAL_CENTER);
                }                
                $objPHPExcel->getActiveSheet()->getStyle($cellName[$j].($i+3))->getAlignment()->setWrapText(true);  
                $objPHPExcel->getActiveSheet(0)->setCellValue($cellName[$j].($i+3), $expTableData[$i][$expCellName[$j][0]]);
            }             
        }  
        header('pragma:public');
        header('Content-type:application/vnd.ms-excel;charset=utf-8;name="'.$xlsTitle.'.xls"');
        header("Content-Disposition:attachment;filename=$fileName.xls");//attachment新窗口打印inline本窗口打印
        $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');  
        $objWriter->save('php://output'); 
        exit;   
    }
    //配送玩具信息
    public function returnsendInfo($where_conditon,$symbol) {
        $MyRes=array();
        $this->checkSession();
        $model = new Model();
        $getSendRes=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where_conditon)
                    ->field('o.business_id,b.way,b.business_title,o.remark,o.card_id,o.toys_number,o.order_time as new_create_time,o.is_size,o.is_prize')
                    ->select();
        $remark="";
        if($getSendRes) {
            foreach ($getSendRes as $k => $val) {
                $is_size=$val['is_size'];
                $tmp_bus_id=$val['business_id'];
                $tmp_bus_title=$val['business_title'];
                $tmp_remark=$val['remark'];
                $tmp_card_id=$val['card_id'];
                $tmp_toys_number=$val['toys_number'];
                $tmp_way=$val['way'];
                $is_prize = $val['is_prize'];
                $tmp_new_create_time = $val['new_create_time'];
                if($k==0) {
                    if($tmp_card_id>0) {
                        $get_card_info=M("toys_card")->where("id=$tmp_card_id ")->find();
                        $get_card_name=$get_card_info['card_name'];
                        if($get_card_name==1) {
                            $remark.="月卡用户";
                        } elseif($get_card_name==2) {
                            $remark.="季卡用户";
                        } elseif($get_card_name==3) {
                            $remark.="半年卡用户";
                        } elseif($get_card_name==4) {
                            $remark.="年卡用户";
                        } else {
                            $remark.="体验卡用户";
                        }
                    }
                    $remark.="  ".$tmp_remark;
                    $br="";
                } else {
                    $br=$symbol.$symbol;
                }
                $send_toys.=$br.$tmp_bus_id;
                if($tmp_toys_number) {
                    $send_toys.="【".$tmp_toys_number."】";
                }
                if($is_prize==3){
                    $is_size = 2;
                }
                if($tmp_way==0){
                    $is_size = 3;
                }
                if($is_size==1) {
                    $toys_size_name="【小】";
                }elseif($is_size==2){
                    $toys_size_name="【彩虹】";
                }elseif($is_size==3){
                    $toys_size_name="【售卖】";
                } else {
                    $toys_size_name="【大】";
                }
                $send_toys.=$symbol.$toys_size_name.$tmp_bus_title;
            }
            $MyRes=array('send_toys'=>$send_toys,'remark'=>$remark,'tmp_new_create_time'=>$tmp_new_create_time);
        }
        return $MyRes;
    }
    
    //取回玩具信息
    public function returnpickInfo($where_conditon,$symbol) {
        $MyRes=array();
        $model = new Model();
        $this->checkSession();
        $getPickRes=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where_conditon)
                    ->field('o.business_id,b.business_title,o.toys_number,o.is_size,o.is_prize,b.business_parts')
                    ->select();
        $business_parts_list = "";
        if($getPickRes) {
            foreach ($getPickRes as $k => $val) {
                $is_size=$val['is_size'];
                $tmp_bus_id=$val['business_id'];
                $tmp_bus_title=$val['business_title'];
                $tmp_bus_parts = $val['business_parts'];//玩具主要检查事项

                //检查事项
                if($tmp_bus_parts){
                    $business_parts_list .= "【".$tmp_bus_title."】：".$tmp_bus_parts.$symbol;
                }

                $tmp_toys_number=$val['toys_number'];
                $tmp_way=$val['way'];
                $is_prize=$val['is_prize'];
                if($is_prize==3){
                    $is_size = 2;
                }
                if($is_size==1) {
                    $toys_size_name="【小】";
                }elseif($is_size==2){
                    $toys_size_name="【彩虹】";
                } else {
                    $toys_size_name="【大】";
                }
                if($k==0) {
                    $br="";
                } else {
                    $br=$symbol.$symbol;
                }
                $pick_toys.=$br.$tmp_bus_id;
                if($tmp_toys_number) {
                    $pick_toys.="【".$tmp_toys_number."】";
                }
                $pick_toys.=$symbol.$toys_size_name.$tmp_bus_title;
            }
            $MyRes=array('pick_toys'=>$pick_toys,'business_parts_list'=>$business_parts_list);
        }
        return $MyRes;
    }
    
    private function checkSession(){
        import("ORG.Util.Session");
    
        //未设置session['username']值或者session过期

        if(!Session::get('username')  ) {
            $url = U('Login/login');
            //$url  = str_replace('/'.MODULE_NAME.'/'.ACTION_NAME.'.html','',$url);
            echo "<script>top.location.href=\"$url\";</script>";
            exit();
        }
        
    }
    //玩具物流列表
    public function getlogisticslist(){
        $str_card_info=$this->getCardInfo();
        $this->checkSession();  
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="case when status=7 then o.state!='77' else  o.state='0' end   and o.business_id not in ($str_card_info) ";
        $model = new Model();

        $order_id=trim(I("order_id"));
        $order_num=trim(I("order_num"));
        $order_status=trim(I("order_status"));
        $business_id=trim(I("business_id"));
        $start_time=I("start_time");
        $end_time=I("end_time");
        $user_id=trim(I("user_id"));
        $toys_number = trim(I("toys_number"));

        if($user_id) {
            if(!$order_id && !$order_num && !$order_status && !$business_id && !$start_time && !$end_time && !$toys_number){
                $order_status = "77" ;
            }
            $where2.=" and o.user_id=$user_id ";
            $this->assign('user_id',$user_id);
        }

        if($toys_number) {
            if(!$order_id && !$order_num && !$order_status && !$business_id && !$start_time && !$end_time && !$user_id){
                $order_status = "88" ;
            }
            $where2.=" and o.toys_number=$toys_number  ";
            $this->assign('toys_number',$toys_number);
        }

        if($order_id) {
            $where2.=" and o.id=$order_id ";
            $this->assign('order_id',$order_id);
        }

        if($order_num) {
            $where2.=" and o.order_num like '%$order_num%' ";
            $this->assign('order_num',$order_num);
        }

        if($order_status) {
            if($order_status == 1){
                $where2.= " and o.status=2 and o.is_ready =0 and o.toys_number is null  ";
            } elseif ($order_status == 2){
                $where2.= " and ((o.status=2 and o.toys_number is not null ) or (o.status=10)) ";
                $ascsql = "o.user_id ASC";
            } elseif($order_status == 77){
                $where2.="  ";
                $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
            }  elseif($order_status == 88){
                $where2.="  ";
                $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
            }else {
                $where2.=" and o.status=$order_status  ";
            }
            $this->assign('order_status',$order_status);
            $order_condition=" o.create_time desc ";
        } else {
            $where2.=" and o.status not in (1,6,8,9,11)  ";
            $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
        }

        if($business_id) {
            $where2.=" and o.business_id=$business_id  ";
            $this->assign('business_id',$business_id);
        }





        if($start_time && $end_time) {
            $where2.=" and o.create_time>='$start_time' and o.create_time<='$end_time'  ";
            $this->assign('start_time',$start_time);
            $this->assign('end_time',$end_time);
        } elseif($start_time) {
            $where2.=" and o.create_time>='$start_time' ";
            $this->assign('start_time',$start_time);
        }

        //满足条件的总记录数
        $count  = $model->table('baby_toys_order as o')
                        ->join(" left join baby_toys_business as b on o.business_id=b.id and o.is_prize in (0,3) ")
                        ->join(" left join baby_toys_prize as p on o.business_id=p.id and o.is_prize='1' ")
                        ->join(" left join baby_user as u on o.user_id=u.id")
                        ->where($where2)
                        ->count();
        $page = new  Page($count,30);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $orderres = $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id and o.is_prize in (0,3) ")
                    ->join(" left join baby_toys_prize as p on o.business_id=p.id and o.is_prize='1' ")
                    ->join(" left join baby_user as u on o.user_id=u.id")
                    ->where($where2)
                    ->field('o.id,o.order_num,o.create_time,o.post_create_time,o.user_id,u.nick_name,u.mobile,o.user_name as ord_user_name,o.mobile as ord_mobile,o.business_id,b.business_title,o.status,o.address,o.combined_order_id,o.toys_number,o.delivery_time,p.prize_title2,o.is_prize')
                    ->order($order_condition)
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        foreach ($orderres as $key => $value) {
            $order_id=$value['id'];
            $order_num=$value['order_num'];
            $combined_order_id=$value['combined_order_id'];
            $prize_title2=$value['prize_title2'];
            $is_prize=$value['is_prize'];
            $order_info=$order_id."<br/>".$order_num."<br/>".$combined_order_id;
            $tmp_user_id=$value['user_id'];
            $user_info="";
            $user_info.=$tmp_user_id;
            $tmp_nick_name=$value['nick_name'];
            if($tmp_nick_name) {
                $user_info.="<br/>".$tmp_nick_name;
            }
            $tmp_mobile=$value['mobile'];
            if($tmp_mobile) {
                $user_info.="<br/>".$tmp_mobile;
            }
            $post_create_time=$value['post_create_time'];
            $create_time=$value['create_time'];
            $business_id=$value['business_id'];
            $business_title=$value['business_title'];
            $toys_number=$value['toys_number'];
            if($is_prize==1) {
                $business_info=$prize_title2."【礼】";
            } else {
                $business_info=$business_id."<br/>".$business_title."<br/>".$toys_number;
            }
            $tmp_status=$value['status'];
            if($tmp_status==2) {
                if($toys_number) {
                    $status_name="待派单";
                } else {
                    $status_name="备货中";
                }
                $listing_status=2;
            }elseif($tmp_status == 1){
                $status_name="待支付";
                $listing_status=1;
            } elseif($tmp_status==5) {
                $status_name="送货中";
                $listing_status=5;
            } elseif($tmp_status==6) {
                $status_name="玩乐中";
                $listing_status=8;
            } elseif($tmp_status==7) {
                $status_name="待入库";
                $listing_status=9;
            } elseif($tmp_status==8){
                $status_name="退款中";
            } elseif($tmp_status==9){
                $status_name="已退款";
            } elseif($tmp_status==10) {
                $status_name="待取回";
                $listing_status=7;
            } elseif($tmp_status==11) {
                $status_name="已入库";
                $listing_status=11;
            }elseif($tmp_status==14) {
                $status_name="恢复玩乐";
                $listing_status=14;
            }
            $lisres =M("toys_listing")
                    ->where("state='0' and order_id=$order_id and status=$listing_status ")
                    ->field('postman_id')
                    ->find();
            if($lisres) {
                $postman_id=$lisres['postman_id'];
            } else {
                $postman_id=0;
            }
            if($postman_id>0) {
                $postuser_id=M("user")->where("id=$postman_id ")->field('nick_name')->find();
                $postman_name=$postuser_id['nick_name'];
            } else {
                $postman_name="";
            }
            
            $address_info="";
            $address=$value['address'];
            $tmp_ord_user_name=$value['ord_user_name'];
            if($tmp_ord_user_name) {
                $address_info.=$tmp_ord_user_name;
            }
            $tmp_ord_mobile=$value['ord_mobile'];
            if($tmp_ord_mobile) {
                $address_info.="<br/>".$tmp_ord_mobile;
            }
            if($address) {
                $address_info.="<br/>".$address;
            }
            $delivery_time=$value['delivery_time'];

            $res[]=array(
                'id'=>$order_id,
                'order_info'=>$order_info,
                'user_info'=>$user_info,
                'address'=>$address_info,
                'post_create_time'=>$post_create_time,
                'create_time'=>$create_time,
                'business_info'=>$business_info,
                'status_name'=>$status_name,
                'delivery_time'=>$delivery_time,
                'postman_name'=>$postman_name
                );
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();   
    }
    
    public function editdelivery(){
        $edit_order_id = I("edit_order_id");
        $delivery_time = I("delivery_time");
        $where['id'] = array('in',$edit_order_id);
        $data['delivery_time'] = $delivery_time ;
        $result = M('toys_order')->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getlogisticslist?order_id=$edit_order_id");
    }
    //编辑物流页面
    public function updatelogistics(){
        //配送人
        $getUserRes =M('toys_order')
                    ->where("state='0' and user_role='4' ")
                    ->field('id,nick_name')
                    ->select();

        $edit_order_id= I("id");
        $orderres =M('toys_order')
                    ->where("id=$edit_order_id")
                    ->field('id,status,business_id,toys_number')
                    ->find();
        $order_id=$orderres['id'];
        $order_status=$orderres['status'];
        $order_toys_number=$orderres['toys_number'];
        $business_id=$orderres['business_id'];
        if($business_id>0) {
            $busres=M('toys_business')
                    ->where("id=$business_id")
                    ->field('business_title,business_pics')
                    ->find();
            $business_title=$busres['business_title'];
            $business_pics=$busres['business_pics'];

            $busLisCon="(business_id=$business_id and state='0' and out_state='0' and is_use='0' ) ";
            if($order_toys_number) {
                $busLisCon.=" or (id=$order_toys_number) ";
            }
            $busLisres=M('toys_business_listing')
                    ->where($busLisCon)
                    ->field('id,tag_id')
                    ->select();
        }
        if(empty($business_title)) {
            $business_title="";
        }
        if($business_pics) {
            $img="http://api.meimei.yihaoss.top/".$business_pics;
        } else {
            $img="";
        }
        $getBusListing=array();
        if($busLisres) {//玩具编号
            foreach ($busLisres as $key => $value) {
                $tag_id=$value['tag_id'];
                $lis_id=$value['id'];
                $getBusListing[]=array(
                    'id'=>$lis_id,
                    'listing_name'=>$lis_id."-".$business_id."-".$tag_id."仓库"
                    );
            }
        }
        $res=array(
            'id'=>$order_id,
            'status'=>$order_status,
            'business_title'=>$business_title,
            'img'=>$img,
            'toys_number'=>$toys_number
            );
        $this->assign('getBusListing',$getBusListing);
        $this->assign('res',$res);
        $this->assign('userInfo',$getUserRes);
        $this->display();   
    }
    //玩具物流列表
    public function getlogisticslist2(){
        $str_card_info=$this->getCardInfo();
        $this->checkSession();  
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="case when status=7 then o.state!='77' else  o.state='0' end   and o.business_id not in ($str_card_info) ";
        $model = new Model();

        $order_id=trim(I("order_id"));
        $order_num=trim(I("order_num"));
        $order_status=trim(I("order_status"));
        $business_id=trim(I("business_id"));
        $start_time=I("start_time");
        $end_time=I("end_time");
        $user_id=trim(I("user_id"));
        $toys_number = trim(I("toys_number"));

        if($user_id) {
            if(!$order_id && !$order_num && !$order_status && !$business_id && !$start_time && !$end_time && !$toys_number){
                $order_status = "77" ;
            }
            $where2.=" and o.user_id=$user_id ";
            $this->assign('user_id',$user_id);
        }

        if($toys_number) {
            if(!$order_id && !$order_num && !$order_status && !$business_id && !$start_time && !$end_time && !$user_id){
                $order_status = "88" ;
            }
            $where2.=" and o.toys_number=$toys_number  ";
            $this->assign('toys_number',$toys_number);
        }

        if($order_id) {
            $where2.=" and o.id=$order_id ";
            $this->assign('order_id',$order_id);
        }

        if($order_num) {
            $where2.=" and o.order_num like '%$order_num%' ";
            $this->assign('order_num',$order_num);
        }

        if($order_status) {
            if($order_status == 1){
                $where2.= " and o.status=2 and o.is_ready =0 and o.toys_number is null  ";
            } elseif ($order_status == 2){
                $where2.= " and ((o.status=2 and o.toys_number is not null ) or (o.status=10)) ";
                $ascsql = "o.user_id ASC";
            } elseif($order_status == 77){
                $where2.="  ";
                $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
            }  elseif($order_status == 88){
                $where2.="  ";
                $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
            }else {
                $where2.=" and o.status=$order_status  ";
            }
            $this->assign('order_status',$order_status);
            $order_condition=" o.create_time desc ";
        } else {
            $where2.=" and o.status not in (1,6,8,9,11)  ";
            $order_condition=" (case when o.status in (10) then o.post_create_time else o.create_time end) desc ";
        }

        if($business_id) {
            $where2.=" and o.business_id=$business_id  ";
            $this->assign('business_id',$business_id);
        }





        if($start_time && $end_time) {
            $where2.=" and o.create_time>='$start_time' and o.create_time<='$end_time'  ";
            $this->assign('start_time',$start_time);
            $this->assign('end_time',$end_time);
        } elseif($start_time) {
            $where2.=" and o.create_time>='$start_time' ";
            $this->assign('start_time',$start_time);
        }

        //满足条件的总记录数
        $count  = $model->table('baby_toys_order as o')
                        ->join(" left join baby_toys_business as b on o.business_id=b.id")
                        ->join(" left join baby_user as u on o.user_id=u.id")
                        ->where($where2)
                        ->count();
        $page = new  Page($count,30);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $orderres = $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->join(" left join baby_user as u on o.user_id=u.id")
                    ->where($where2)
                    ->field('o.id,o.order_num,o.create_time,o.post_create_time,o.user_id,u.nick_name,u.mobile,o.user_name as ord_user_name,o.mobile as ord_mobile,o.business_id,b.business_title,o.status,o.address,o.combined_order_id,o.toys_number,o.delivery_time')
                    ->order($order_condition)
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        foreach ($orderres as $key => $value) {
            $order_id=$value['id'];
            $order_num=$value['order_num'];
            $combined_order_id=$value['combined_order_id'];
            $order_info=$order_id."<br/>".$order_num."<br/>".$combined_order_id;
            $tmp_user_id=$value['user_id'];
            $user_info="";
            $user_info.=$tmp_user_id;
            $tmp_nick_name=$value['nick_name'];
            if($tmp_nick_name) {
                $user_info.="/".$tmp_nick_name;
            }
            $tmp_mobile=$value['mobile'];
            if($tmp_mobile) {
                $user_info.="/".$tmp_mobile;
            }
            $post_create_time=$value['post_create_time'];
            $create_time=$value['create_time'];
            $business_id=$value['business_id'];
            $business_title=$value['business_title'];
            $toys_number=$value['toys_number'];
            $business_info=$business_id."/".$business_title."/".$toys_number;
            $tmp_status=$value['status'];
            if($tmp_status==2) {
                if($toys_number) {
                    $status_name="待派单";
                } else {
                    $status_name="备货中";
                }
                $listing_status=2;
            }elseif($tmp_status == 1){
                $status_name="待支付";
                $listing_status=1;
            } elseif($tmp_status==5) {
                $status_name="送货中";
                $listing_status=5;
            } elseif($tmp_status==6) {
                $status_name="玩乐中";
                $listing_status=8;
            } elseif($tmp_status==7) {
                $status_name="待入库";
                $listing_status=9;
            } elseif($tmp_status==8){
                $status_name="退款中";
            } elseif($tmp_status==9){
                $status_name="已退款";
            } elseif($tmp_status==10) {
                $status_name="待取回";
                $listing_status=7;
            } elseif($tmp_status==11) {
                $status_name="已入库";
                $listing_status=11;
            }elseif($tmp_status==14) {
                $status_name="恢复玩乐";
                $listing_status=14;
            }
            $lisres =M("toys_listing")
                    ->where("state='0' and order_id=$order_id and status=$listing_status ")
                    ->field('postman_id')
                    ->find();
            if($lisres) {
                $postman_id=$lisres['postman_id'];
            }
            if($postman_id) {
                $postuser_id=M("user")->where("id=$postman_id ")->field('nick_name')->find();
                $postman_name=$postuser_id['nick_name'];
            }
            if(empty($postman_name)) {
                $postman_name="";
            }
            $address_info="";
            $address=$value['address'];
            $tmp_ord_user_name=$value['ord_user_name'];
            if($tmp_ord_user_name) {
                $address_info.=$tmp_ord_user_name;
            }
            $tmp_ord_mobile=$value['ord_mobile'];
            if($tmp_ord_mobile) {
                $address_info.="/".$tmp_ord_mobile;
            }
            if($address) {
                $address_info.="/".$address;
            }
            $delivery_time=$value['delivery_time'];

            $res[]=array(
                'id'=>$order_id,
                'order_num'=>$order_num,
                'combined_order_id'=>$combined_order_id,
                //'order_info'=>$order_info,
                'user_info'=>$user_info,
                'address'=>$address_info,
                'post_create_time'=>$post_create_time,
                'create_time'=>$create_time,
                'business_info'=>$business_info,
                'status_name'=>$status_name,
                'delivery_time'=>$delivery_time,
                'postman_name'=>$postman_name
                );
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();   
    }
    //派单列表
    public function getsendlist() {
        $this->checkSession(); 
        $user_id=I("user_id");
        $day_ago=date("Y-m-d 00:00:00", strtotime ("-2 day"));
        $search_condition_id=I("search_condition_id");
        $search_address=I("search_address");
        $excel_state=I("excel_state");
        $arr_user_id=I("arr_user_id");
        $str_card_info=$this->getCardInfo(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2=" o.business_id not in ($str_card_info) and o.state='0' and a.state='0' and a.is_defalut='1' and o.is_prize in (0,3,5)  ";
        if($user_id>0) {
            $where2.=" and o.user_id=$user_id ";
            $this->assign('user_id',$user_id);
            $order_condion="update_time desc ";
        } elseif($arr_user_id) {
            $tmp_user_id=explode("、", $arr_user_id);
            $real_arr_user_id=array();
            foreach ($tmp_user_id as $value) {
                if($value>0) {
                    $real_arr_user_id[]=$value;
                }
            }
            $str_user_id=implode(",", $real_arr_user_id);
            $where2.=" and o.user_id in ($str_user_id) ";
            $this->assign('arr_user_id',$arr_user_id);
            $order_condion="FIELD(o.user_id,$str_user_id) ";
        } else {
            $order_condion="update_time desc ";
        }
        if($search_condition_id==1) {//已超过2天
            $where2.=" and o.status in (2,17) and o.create_time<'$day_ago'  ";
            $this->assign('search_condition_id',$search_condition_id);
        } elseif($search_condition_id==2) {//取消过派单
            $where2.=" and o.status in (2,17) and o.cancel_reason in (1,2,3)  ";
            $this->assign('search_condition_id',$search_condition_id);
        } elseif($search_condition_id==3) {//已超2天-取消过
            $where2.=" and o.status in (2,17) and o.create_time<'$day_ago' and o.cancel_reason in (1,2,3)  ";
            $this->assign('search_condition_id',$search_condition_id);
        } else {
            $where2.=" and ((o.status in (2,17)) or (o.status=10 and l.status=7 and l.state='0' and l.postman_id=0 ) )  ";
        }
        if($search_address) {
            $where2.=" and a.address like '%$search_address%' ";
            $this->assign('search_address',$search_address);
        }
        $model = new Model();
        if($excel_state==1) {//导出
            $getexcelUserRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_listing as l on l.order_id=o.id")
                    ->join(" left join baby_user_address as a on a.user_id=o.user_id ")
                    ->where($where2)
                    ->field("o.user_id,max(o.create_time) update_time,a.user_name,a.mobile,a.address ")
                    ->group("o.user_id")
                    ->order($order_condion)
                    ->select();
            $xlsData=array();
            if($getexcelUserRes) {
                $xlsName="派单";
                $xlsCell  = array(
                    array('user_id','用户id/下单时间'),
                    array('user_info','配送信息'),
//                    array('new_create_time','下单时间'),
                    array('send_toys','待配送'),
                    array('pick_toys','待取回'),
                    array('remark','备注'),
                    array('business_parts_list','注意事项'),
                    array('user_act','用户操作')
                );
                foreach ($getexcelUserRes as $key => $value) {
                    $tmp_user_id=$value['user_id'];
                    $order_user_name=$value['user_name'];
                    $order_mobile=$value['mobile'];
                    $order_address=$value['address'];
                    $user_info=$send_toys=$pick_toys="";
                    if($order_user_name) {
                        $user_info.=$order_user_name;
                    }
                    if($order_mobile) {
                        $user_info.="\n".$order_mobile;
                    }
                    if($order_address) {
                        $user_info.="\n".$order_address;
                    }
                    $send_toys=$pick_toys="";

                    //配送
                    $returnsendInfo=$this->returnsendInfo("o.status in (2,17) and o.business_id not in ($str_card_info) and o.state='0' and o.user_id=$tmp_user_id and o.is_prize in (0,3) ","\n");
                    if(empty($returnsendInfo) ) {
                        $tmp_remark="";
                    } else {
                        $send_toys=$returnsendInfo['send_toys'];
                        $tmp_remark=$returnsendInfo['remark'];
                        $tmp_new_create_time=$returnsendInfo['tmp_new_create_time'];
                    }
                    $checkBatRes=M("toys_order")
                            ->where("user_id=$tmp_user_id and is_prize='2' and is_battery='1' and state='0' and status in (2,17) ")
                            ->field("combined_order_id,battery_brand ")
                            ->select();
                    if($checkBatRes) {
                        foreach ($checkBatRes as $k=> $va) {
                            $bat_combined_order_id=$va['combined_order_id'];
                            $bat_battery_brand=$va['battery_brand'];
                            $getreturnBatteryInfo=$this->returnBatteryInfo($bat_combined_order_id,"\n",$bat_battery_brand,$tmp_user_id);
                            if($k==0) {
                                $symbol="\n\n";
                            } else {
                                $symbol="\n";
                            }
                            $send_toys.=$symbol.$getreturnBatteryInfo;
                        }
                    }
                    $get_user_remark=M("toys_user_remark")
                                ->field("remark")
                                ->where("user_id=$tmp_user_id and state='0' ")
                                ->find();
                    $remark=$tmp_remark.$get_user_remark['remark'];
                    $getPrizeRes=$model->table('baby_toys_order as o')
                        ->join(" left join baby_toys_prize as b on o.business_id=b.id")
                        ->where("o.status in (2,17) and o.user_id=$tmp_user_id and o.is_prize='1' and o.state='0' ")
                        ->field('b.prize_title2')
                        ->select();
                    if($getPrizeRes) {
                        foreach ($getPrizeRes as $k => $val) {
                            $tmp_bus_title=$val['prize_title2'];
                            if($k==0) {
                                $symbol="\n\n";
                            } else {
                                $symbol="\n";
                            }
                            $send_toys.=$symbol."【礼品】".$tmp_bus_title;
                        }
                    }
                    $business_parts_lists = "";
                    $returnpickInfo=$this->returnpickInfo("o.status in (10) and o.state='0' and o.user_id=$tmp_user_id ","\n");
                    if($returnpickInfo) {
                        $pick_toys=$returnpickInfo['pick_toys'];
                        $business_parts_lists = $returnpickInfo['business_parts_list'];
                    }
                    $user_act = " □ 玩具实物和所租是否相符\n □ 需安装玩具是否安装\n □ 玩具是否干净\n 签收人：____________";
                    $xlsData[]=array(
                        'user_id'=>$tmp_user_id."\n".$tmp_new_create_time,
                        'user_info'=>$user_info,
//                        'new_create_time'=>$tmp_new_create_time,
                        'send_toys'=>$send_toys,
                        'pick_toys'=>$pick_toys,
                        'remark'=>$remark,
                        'business_parts_list' => $business_parts_lists,
                        'user_act' => $user_act
                    );
                }
                $this->exportExcel($xlsName,$xlsCell,$xlsData);
            }
        }


        //满足条件的总记录数
        $user_count  = $model->table('baby_toys_order as o')
                        ->join(" left join baby_user_address as a on a.user_id=o.user_id ")
                        ->join(" left join baby_toys_listing as l on l.order_id=o.id")
                        ->where($where2)
                        ->field('o.user_id')
                        ->group("o.user_id")
                        ->select();
        $count=count($user_count);
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_user_address as a on a.user_id=o.user_id ")
                    ->join(" left join baby_toys_listing as l on l.order_id=o.id")
                    ->where($where2)
                    ->field("o.user_id,max(o.create_time ) update_time,a.user_name,a.mobile,a.address ")
                    ->group("o.user_id")
                    ->order($order_condion)
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $tmp_user_id=$value['user_id'];
                $order_user_name=$value['user_name'];
                $order_mobile=$value['mobile'];
                $order_address=$value['address'];
                $user_info=$send_toys=$pick_toys="";
                if($order_user_name) {
                    $user_info.=$order_user_name;
                }
                if($order_mobile) {
                    $user_info.="<br/>".$order_mobile;
                }
                if($order_address) {
                    $user_info.="<br/>".$order_address;
                }
                $send_toys=$pick_toys="";
                //配送
                $returnsendInfo=$this->returnsendInfo("o.status in (2,17) and o.business_id not in ($str_card_info) and o.state='0' and o.user_id=$tmp_user_id and o.is_prize in (0,3) ","<br/>");
                if(empty($returnsendInfo)) {
                    $tmp_remark="";
                } else {
                    $send_toys=$returnsendInfo['send_toys'];
                    $tmp_remark=$returnsendInfo['remark'];
                    $tmp_new_create_time=$returnsendInfo['tmp_new_create_time'];
                }
                $checkBatRes=M("toys_order")
                            ->where("user_id=$tmp_user_id and is_prize='2' and is_battery='1' and state='0' and status in (2,17) ")
                            ->field("combined_order_id,battery_brand ")
                            ->select();
                if($checkBatRes) {
                    foreach ($checkBatRes as $k => $va) {
                        $bat_combined_order_id=$va['combined_order_id'];
                        $bat_battery_brand=$va['battery_brand'];
                        $getreturnBatteryInfo=$this->returnBatteryInfo($bat_combined_order_id,"<br/>",$bat_battery_brand,$tmp_user_id);
                        if($k==0) {
                            $symbol="<br/><br/>";
                        } else {
                            $symbol="<br/>";
                        }
                        $send_toys.=$symbol.$getreturnBatteryInfo;
                    }
                }
                $get_user_remark=M("toys_user_remark")
                            ->field("remark")
                            ->where("user_id=$tmp_user_id and state='0' ")
                            ->find();
                $remark=$tmp_remark.$get_user_remark['remark'];

                $getPrizeRes=$model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_prize as b on o.business_id=b.id")
                    ->where("o.status in (2,17) and o.user_id=$tmp_user_id and o.is_prize='1' and o.state='0' ")
                    ->field('b.prize_title2')
                    ->select();
                if($getPrizeRes) {
                    foreach ($getPrizeRes as $k => $val) {
                        $tmp_bus_title=$val['prize_title2'];
                        if($k==0) {
                            $symbol="<br/><br/>";
                        } else {
                            $symbol="<br/>";
                        }
                        $send_toys.=$symbol."【礼品】".$tmp_bus_title;
                    }
                }
                $returnpickInfo=$this->returnpickInfo("o.status in (10) and o.state='0' and o.user_id=$tmp_user_id ","<br/>");
                if($returnpickInfo) {
                    $pick_toys=$returnpickInfo['pick_toys'];
                }
                $res[]=array(
                    'user_id'=>$tmp_user_id,
                    'user_info'=>$user_info,
                    'send_toys'=>$send_toys,
                    'pick_toys'=>$pick_toys,
                    'remark'=>$remark,
                    'new_create_time'=>$tmp_new_create_time
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }
    
    //派单加备注页面
    public function editsendremark() {
        $user_id=I("user_id");
        $str_card_info=$this->getCardInfo();
        $getSendRes=M("toys_order")
                    ->where("status in (2,5,10,17) and business_id not in ($str_card_info) and state='0' and user_id=$user_id ")
                    ->field('stock_remark')
                    ->order("id desc")
                    ->find();
        $remark=$getSendRes['stock_remark'];
        $this->assign('user_id',$user_id);
        $this->assign('remark',$remark);
        $this->display();
    }
    //备货列表
    public function getstocklist() {
        $this->checkSession(); 
        $search_business_id=I("business_id");
        $excel_state=I("excel_state");
        $str_card_info=$this->getCardInfo(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="o.status in (2) and o.business_id not in ($str_card_info) and o.state='0' and ((o.toys_number is null) or (o.toys_number='') ) ";
        if($search_business_id) {
            $where2.=" and o.business_id=$search_business_id ";
            $this->assign('search_business_id',$search_business_id);
        }
        $model = new Model();
        if($excel_state==1) {
            $getexcelBusRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where2)
                    ->field("o.business_id,b.business_title ")
                    ->group("o.business_id")
                    ->order("o.business_id desc")
                    ->select();
            $xlsData=array();
            if($getexcelBusRes) {
                $xlsName="备货";
                $xlsCell  = array(
                    array('business_id','玩具id'),
                    array('business_title','玩具名'),
                    array('ready_number','待备货数量')  
                );
                foreach ($getexcelBusRes as $key => $value) {
                    $tmp_business_id=$value['business_id'];
                    $tmp_business_title=$value['business_title'];
                    $ready_number=M('toys_order')
                        ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and ((toys_number is null) or (toys_number='') ) ")
                        ->count();//待备货数量
                    
                    $xlsData[]=array(
                        'business_id'=>$tmp_business_id,
                        'business_title'=>$tmp_business_title,
                        'ready_number'=>$ready_number
                    );
                }
                $this->exportExcel($xlsName,$xlsCell,$xlsData);
            }
        }
        //满足条件的总记录数
        $user_count  = $model->table('baby_toys_order as o')
                        ->where($where2)
                        ->field('o.business_id')
                        ->group("o.business_id")
                        ->select();
        $count=count($user_count);
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where2)
                    ->field("o.business_id,b.business_title ")
                    ->group("o.business_id")
                    ->order("o.business_id desc")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $tmp_business_id=$value['business_id'];
                $tmp_business_title=$value['business_title'];
                $ready_number=M('toys_order')
                    ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and ((toys_number is null) or (toys_number='') ) ")
                    ->count();//待备货数量
                $res[]=array(
                    'business_id'=>$tmp_business_id,
                    'business_title'=>$tmp_business_title,
                    'ready_number'=>$ready_number
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }
    public function getstocklist0814() {
        $this->checkSession(); 
        $search_business_id=I("business_id");
        $excel_state=I("excel_state");
        $str_card_info=$this->getCardInfo(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="o.status in (2) and o.business_id not in ($str_card_info) and o.state='0' ";
        if($search_business_id) {
            $where2.=" and o.business_id=$search_business_id ";
            $this->assign('search_business_id',$search_business_id);
        }
        $model = new Model();
        if($excel_state==1) {
            $getexcelBusRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where2)
                    ->field("o.business_id,b.business_title ")
                    ->group("o.business_id")
                    ->order("o.business_id desc")
                    ->select();
            $xlsData=array();
            if($getexcelBusRes) {
                $xlsName="备货";
                $xlsCell  = array(
                    array('business_id','玩具id'),
                    array('business_title','玩具名'),
                    array('total_number','备货总数量'),
                    array('ready_number','待备货数量'),
                    array('over_number','已备货数量/编号')   
                );
                foreach ($getexcelBusRes as $key => $value) {
                    $tmp_business_id=$value['business_id'];
                    $tmp_business_title=$value['business_title'];
                    
                    $total_number=M('toys_order')
                        ->where("status in (2) and business_id in ($tmp_business_id) and state='0' ")
                        ->count();//总数量

                    $ready_number=M('toys_order')
                        ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and ((toys_number is null) or (toys_number='') ) ")
                        ->count();//待备货数量
                    $getHaveToysNumberRes=M('toys_order')
                        ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and toys_number is not null ")
                        ->field('toys_number')
                        ->select();
                    $arr_toys_number=array();
                    $str_toys_number=$over_number="";
                    $getHaveToysNumber=count($getHaveToysNumberRes);
                    $over_number.=$getHaveToysNumber;
                    if($getHaveToysNumberRes) {
                        foreach ($getHaveToysNumberRes as $k => $val) {
                            $arr_toys_number[]=$val['toys_number'];
                        }
                        $str_toys_number=implode(",", $arr_toys_number);
                        $over_number.="【".$str_toys_number."】";
                    } else {
                        $getHaveToysNumberCount=0;
                    }
                    
                    $xlsData[]=array(
                        'business_id'=>$tmp_business_id,
                        'business_title'=>$tmp_business_title,
                        'total_number'=>$total_number,
                        'ready_number'=>$ready_number,
                        'over_number'=>$over_number
                    );
                }
                $this->exportExcel($xlsName,$xlsCell,$xlsData);
            }
        }
        //满足条件的总记录数
        $user_count  = $model->table('baby_toys_order as o')
                        ->where($where2)
                        ->field('o.business_id')
                        ->group("o.business_id")
                        ->select();
        $count=count($user_count);
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_business as b on o.business_id=b.id")
                    ->where($where2)
                    ->field("o.business_id,b.business_title ")
                    ->group("o.business_id")
                    ->order("o.business_id desc")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $tmp_business_id=$value['business_id'];
                $tmp_business_title=$value['business_title'];
                
                $total_number=M('toys_order')
                    ->where("status in (2) and business_id in ($tmp_business_id) and state='0' ")
                    ->count();//总数量

                $ready_number=M('toys_order')
                    ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and ((toys_number is null) or (toys_number='') ) ")
                    ->count();//待备货数量
                $getHaveToysNumberRes=M('toys_order')
                    ->where("status in (2) and business_id in ($tmp_business_id) and state='0' and toys_number is not null ")
                    ->field('toys_number')
                    ->select();
                $arr_toys_number=array();
                $str_toys_number=$over_number="";
                $getHaveToysNumber=count($getHaveToysNumberRes);
                $over_number.=$getHaveToysNumber;
                if($getHaveToysNumberRes) {
                    foreach ($getHaveToysNumberRes as $k => $val) {
                        $arr_toys_number[]=$val['toys_number'];
                    }
                    $str_toys_number=implode(",", $arr_toys_number);
                    $over_number.="【".$str_toys_number."】";
                } else {
                    $getHaveToysNumberCount=0;
                }
                
                $res[]=array(
                    'business_id'=>$tmp_business_id,
                    'business_title'=>$tmp_business_title,
                    'total_number'=>$total_number,
                    'ready_number'=>$ready_number,
                    'over_number'=>$over_number
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }
    //黑名单列表
    public function getblacklist() {
        $this->checkSession(); 
        $user_id=I("user_id"); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="state='0' ";
        if($user_id) {
            $where2.=" and user_id=$user_id ";
            $this->assign('user_id',$user_id);
        }
        $model = new Model();
        //满足条件的总记录数
        $count= M("toys_black")->where($where2)->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getBlackRes= M("toys_black")
                    ->where($where2)
                    ->order("id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getBlackRes) {
            foreach ($getBlackRes as $key => $value) {
                $tmp_id=$value['id'];
                $tmp_user_id=$value['user_id'];
                $business_id=$value['business_id'];
                $remark=$value['remark'];
                $status=$value['status'];
                if($status==2) {
                    $status_name="更重";
                } elseif($status==1) {
                    $status_name="重";
                } else {
                    $status_name="轻微";
                }
                $business_info="";
                if($business_id>0) {
                    $getBusRes=M("toys_business")->where("id=$business_id ")
                            ->field('business_title')
                            ->find();
                    $business_title=$getBusRes['business_title'];
                    $business_info.=$business_id."<br/>".$business_title;
                }
                $res[]=array(
                    'id'=>$tmp_id,
                    'user_id'=>$tmp_user_id,
                    'business_info'=>$business_info,
                    'remark'=>$remark,
                    'status_name'=>$status_name
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //黑名单列表
    public function newbusinesslisting() {
        $this->checkSession();
        $business_id=I("business_id");
        $business_id = trim($business_id);
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="state='0' and status=1 ";
        if($business_id) {
            $where2.=" and business_id=$business_id ";
            $this->assign('business_id',$business_id);
        }
        $model = new Model();
        //满足条件的总记录数
        $count= M("toys_new_business_listing")->where($where2)->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getBlackRes= M("toys_new_business_listing")
            ->where($where2)
            ->order("id desc ")
            ->limit($page->firstRow,$page->listRows)
            ->select();
        $res=array();
        if($getBlackRes) {
            foreach ($getBlackRes as $key => $value) {
                $id=$value['id'];
                $business_id=$value['business_id'];
                $create_time=$value['create_time'];
                $status=$value['status'];
                $business_title = $value['business_title'];
                $business_pic = "https://api.meimei.yihaoss.top/".$value['business_pic'];


                $res[]=array(
                    'id'=>$id,
                    'business_id'=>$business_id,
                    'create_time'=>$create_time,
                    'business_title'=>$business_title,
                    'business_pic'=>$business_pic,
                    'status'=>$status
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除新增申请列表
    public function delnewbusinesslisting(){
        $id = $_GET['id'];
        $album = M('toys_new_business_listing');
        $where['id'] = array('in',$id);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/newbusinesslisting.html");
    }
    //删除黑名单列表
    public function operator_blackstate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_black');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getblacklist.html");
    }
    //添加/编辑黑名单信息页面
    public function editblack() {
        $id=I("id"); 
        if($id>0) {
            $getBlackRes=M("toys_black")->where("id=$id")->find();
        }
        $this->assign('res',$getBlackRes);//赋值数据集
        $this->display();
    }
    //添加玩具07-11
    public function publictoysnew() {
        $this->checkSession();
        $id = $_GET['id'];
        if($id){
            $is_new = 0;
        }else{
            $is_new = 1;
        }
        $this->assign('is_new',$is_new);//1发布新玩具，0编辑玩具

        $where2['id'] = array('in',$id);
        $list = M('toys_business')
            ->where($where2)
            ->find();
        $res=array();
        $way=$list['way'];
        $tmp_market_price=$list['market_price'];
        $tmp_sell_price=$list['sell_price'];
        $tmp_member_price=$list['member_price'];
        if($way==1) {
            $market_price2=$tmp_market_price;
            $sell_price2=$tmp_sell_price;
            $market_price1=$sell_price1="";
        } else {
            $market_price2=$sell_price2="";
            $market_price1=$tmp_market_price;
            $sell_price1=$tmp_sell_price;
        }

        $res=array(
            'id'=>$list['id'],
            'business_title'=>$list['business_title'],
            'business_contact'=>$list['business_contact'],
            'qq'=>$list['qq'],
            'business_des'=>$list['business_des'],
            'main_part'=>$list['main_part'],
            'parts'=>$list['parts'],
            'weight'=>$list['weight'],
            'size'=>$list['size'],
            'color'=>$list['color'],
            'business_location'=>$list['business_location'],
            'way'=>$list['way'],
            'is_support'=>$list['is_support'],
            'market_price1'=>$market_price1,
            'sell_price1'=>$sell_price1,
            'market_price2'=>$market_price2,
            'sell_price2'=>$sell_price2,
            'need_price'=>$list['need_price'],
            'service_price'=>$list['service_price'],
            'highest_price'=>$list['highest_price'],
            'member_price'=>$tmp_member_price,
            'age'=>$list['age'],
            'root_img_id'=>$list['root_img_id'],
            'is_card'=>$list['is_card'],
            'number'=>$list['number'],
            'is_active'=>$list['is_active'],
            'contract_number'=>$list['contract_number'],
            'total_number'=>$list['total_number'],
            'number_title'=>$list['number_title'],
            'service_number'=>$list['service_number'],
            'battery_price'=>$list['battery_price'],
            'battery_number1'=>$list['battery_number1'],
            'battery_number2'=>$list['battery_number2'],
            'battery_number3'=>$list['battery_number3'],
            'battery_number4'=>$list['battery_number4'],
            'battery_number5'=>$list['battery_number5'],
            'battery_number6'=>$list['battery_number6'],
            'battery_number7'=>$list['battery_number7'],
            'battery_number8'=>$list['battery_number8'],
            'key_words'=>$list['key_words'],
            'weight'=>$list['weight'],
            'size'=>$list['size'],
            'business_brand'=>$list['business_brand']
        );
        if(empty($id)) {
            $res=array(
                'way'=>"1"
            );
        }
        $Imgs=$list['business_pics'];
        if($Imgs) {
            $array_pics = explode(";",$Imgs);
        } else {
            $array_pics=array();
        }
        if($array_pics) {
            if($array_pics[0]) {
                $res['pic1']="http://api.meimei.yihaoss.top/".$array_pics[0];
            }
            if($array_pics[1]) {
                $res['pic2']="http://api.meimei.yihaoss.top/".$array_pics[1];
            }
            if($array_pics[2]) {
                $res['pic3']="http://api.meimei.yihaoss.top/".$array_pics[2];
            }
            if($array_pics[3]) {
                $res['pic4']="http://api.meimei.yihaoss.top/".$array_pics[3];
            }
            if($array_pics[4]) {
                $res['pic5']="http://api.meimei.yihaoss.top/".$array_pics[4];
            }
            if($array_pics[5]) {
                $res['pic6']="http://api.meimei.yihaoss.top/".$array_pics[5];
            }
            if($array_pics[6]) {
                $res['pic7']="http://api.meimei.yihaoss.top/".$array_pics[6];
            }
            if($array_pics[7]) {
                $res['pic8']="http://api.meimei.yihaoss.top/".$array_pics[7];
            }
        }
        $this->assign("res",$res);
        $tmp_category_ids=$list['category_ids'];
        if($tmp_category_ids) {
            $array_category_id=explode(",",$tmp_category_ids);
        }
        $this->assign('categoryInfo',$array_category_id);
        $cate_info=M("toys_category")
            ->field('title,category_id')
            ->where("state=0")
            ->select();
        $this->assign('cate_info',$cate_info);
        //$this->assign('list',$list);//赋值数据集
        //$this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //添加新编号入库
    public function publictoysnewnumberin(){
        $this->checkSession();
        $business_id = $_GET['business_id'];
        $this->assign("business_id",$business_id);
        $source = I("source");
        $new_id = I("id");
        $this->assign("source",$source);
        $this->assign("new_id",$new_id);

        //查询操作人
        $post_img = M('user');
        $model = new Model();
        $list = $post_img
            ->where("state='0' and user_role in ('4','6') and id not in('1','182','674','305416','312287','423859','424069','425412','307167','95371','305060','426894','309806','421524','427215','427592')  ")
            ->field('id,user_name')
            ->select();
        $res=array();
        foreach($list as $v){
            $user_id = $v['id'];
            $user_name = $v['user_name'];
            $res[] = array(
                'user_id'=>$user_id,
                'user_name'=>$user_name
            );
        }
        $this->assign("res",$res);
        $this->display();
    }

    //添加新编号出库
    public function publictoysnewnumberout(){
        $this->checkSession();
        $business_id = $_GET['business_id'];
        $this->assign("business_id",$business_id);
        $source = I("source");
        $new_id = I("id");
        $this->assign("source",$source);
        $this->assign("new_id",$new_id);

        //查询操作人
        $post_img = M('user');
        $model = new Model();
        $list = $post_img
            ->where("state='0' and user_role in ('4','6') and id not in('1','182','674','305416','312287','423859','424069','425412','307167','95371','305060','426894','309806','421524','427215','427592')  ")
            ->field('id,user_name')
            ->select();
        $res=array();
        foreach($list as $v){
            $user_id = $v['id'];
            $user_name = $v['user_name'];
            $res[] = array(
                'user_id'=>$user_id,
                'user_name'=>$user_name
            );
        }
        $this->assign("res",$res);
        $this->display();
    }

    //卡操作页面
    public function publiccard() {
        $id=I("id"); 
        if($id>0) {
            $getBusRes=M("toys_business")->where("id=$id")->find();
            $root_img_id=$getBusRes['root_img_id'];
            $old_Imgs=$getBusRes['old_business_pics'];
            $Imgs=$getBusRes['business_pics'];
            if($Imgs) {
                $array_pics = explode(";",$Imgs);
            } else {
                $array_pics=array();
            }   
            if($array_pics) {
                if($root_img_id>0) {
                    if($array_pics[0]) {
                        $getBusRes['pic1']="http://api.meimei.yihaoss.top/".$array_pics[0];
                    }
                    if($array_pics[1]) {
                        $getBusRes['pic2']="http://api.meimei.yihaoss.top/".$array_pics[1];
                    }
                    if($array_pics[2]) {
                        $getBusRes['pic3']="http://api.meimei.yihaoss.top/".$array_pics[2];
                    }
                    if($array_pics[3]) {
                        $getBusRes['pic4']="http://api.meimei.yihaoss.top/".$array_pics[3];
                    }
                } else {
                    if($array_pics[0]) {
                        $getBusRes['cover']="http://api.meimei.yihaoss.top/".$array_pics[0];
                    }
                    if($old_Imgs) {
                        $getBusRes['old_cover']="http://api.meimei.yihaoss.top/".$old_Imgs;
                    }
                }
            }    
        }
        $this->assign('res',$getBusRes);//赋值数据集
        $this->display();
    }
    //玩具帖子列表
    public function toysreplylist(){
        $this->checkSession();
        $id = $_GET['id'];
        $str_card_info=$this->getCardInfo();
        $arr_card_info = explode(',',$str_card_info);
        $is_card = 0;
        if(in_array($id,$arr_card_info)){
            $is_card = 1;  //判断是不是卡
        }
        $this->assign('is_card',$is_card);

        import("ORG.Util.Page");
        //先查相册的数据库，
        $post_img = M('toys_business');
        $where2['state'] ='0';
        $model = new Model();
        $list = $post_img
            ->where("state='0' and (root_img_id={$id} or id={$id})  ")
            ->field('id,business_des,business_pics')
            ->order('root_img_id asc,id asc')
            ->select();
        $res=array();
        foreach($list as $key=>$value){
            $id = $value['id'];
            $tmpImg = $value['business_pics'];
            $business_des = $value['business_des'];
            $Imgs=explode(';',$tmpImg);
            $imgUrl=array();
            if(!empty($Imgs)){
                foreach ($Imgs as $key=>$tmpImg){
                    $imgUrl[]="http://api.meimei.yihaoss.top/".$tmpImg;
                }
            } else {
                $imgUrl=array();
            }
            $res[]=array(
                'id'=>$id,
                'business_des'=>$business_des,
                'imgUrl'=>$imgUrl
            );
        }
        $this->assign("res",$res);
        $this->display();
    }
    //采购建议操作页面
    public function pubpuradvice() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_purchasing_advice")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //采购建议列表
    public function getpuradvice() {
        $search_user_id=I("search_user_id");
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="state='0' ";
        if($search_user_id>0) {
            $where2.=" and user_info like '%$search_user_id%' ";
            $this->assign('search_user_id',$search_user_id);
        }
        $model = new Model();
        //满足条件的总记录数
        $user_count  = $model->table('baby_toys_purchasing_advice')
                        ->where($where2)
                        ->select();
        $count=count($user_count);
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_purchasing_advice')
                    ->where($where2)
                    ->order("id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $create_time=$value['create_time'];
                $user_info=$value['user_info'];
                $toys_info=$value['toys_info'];
                $public_name=$value['public_name'];
                $id=$value['id'];
                $tmp_purchase_reamrk=$value['purchase_reamrk'];
                $tmp_reply_reamrk=$value['reply_reamrk'];
                $purchase_time=$value['purchase_time'];
                $reply_time=$value['reply_time'];
                $purchase_reamrk=$reply_reamrk="";
                if($tmp_purchase_reamrk) {
                    $purchase_reamrk=$tmp_purchase_reamrk."<br/>".$purchase_time;
                }
                if($tmp_reply_reamrk) {
                    $reply_reamrk=$tmp_reply_reamrk."<br/>".$reply_time ;
                }
                $res[]=array(
                    'user_info'=>$user_info,
                    'toys_info'=>$toys_info,
                    'purchase_reamrk'=>$purchase_reamrk,
                    'id'=>$id,
                    'reply_reamrk'=>$reply_reamrk,
                    'create_time'=>$create_time,
                    'public_name'=>$public_name
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除采购建议
    public function operator_advicestate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_purchasing_advice');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getpuradvice.html");
    }
    //删除电池价格
    public function operator_baterrypricestate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_battery');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getbaterypricelist.html");
    }
     //电池价格列表
    public function getbaterypricelist() {
        $this->checkSession(); 
        $search_type=I("search_type");
        $search_brand=I("search_brand");
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="state='0' ";
        if($search_type) {
            $where2.=" and type=$search_type ";
            $this->assign('search_type',$search_type);
        }
        if($search_brand) {
            $where2.=" and brand=$search_brand ";
            $this->assign('search_brand',$search_brand);
        }
        $model = new Model();
        //满足条件的总记录数
        $count= $model->table('baby_toys_battery')
                        ->where($where2)
                        ->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_battery')
                    ->where($where2)
                    ->order("id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $tmp_id=$value['id'];
                $type=$value['type'];
                $brand=$value['brand'];
                $price=$value['price'];
                $market_price=$value['market_price'];
                if($price<=0) {
                    $price="";
                }
                if($market_price<=0) {
                    $market_price="";
                }
                if($brand==1) {
                    $battery_brand="华太";
                } elseif($brand==2) {
                    $battery_brand="南孚";
                } elseif($brand==3) {
                    $battery_brand="双鹿";
                } else {
                    $battery_brand="";
                }
                if($type==1) {
                    $battery_type="1号电池";
                } elseif($type==2) {
                    $battery_type="2号电池";
                } elseif($type==3) {
                    $battery_type="3号电池";
                } elseif($type==4) {
                    $battery_type="4号电池";
                } elseif($type==5) {
                    $battery_type="5号电池";
                } elseif($type==6) {
                    $battery_type="6号电池";
                } elseif($type==7) {
                    $battery_type="7号电池";
                } elseif($type==8) {
                    $battery_type="纽扣电池";
                }
                $res[]=array(
                    'id'=>$tmp_id,
                    'battery_type'=>$battery_type,
                    'battery_brand'=>$battery_brand,
                    'price'=>$price,
                    'market_price'=>$market_price
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }
    //电池操作页面
    public function pubbateryprice() {
        $id=I("id"); 
        if($id>0) {
            $getBusRes=M("toys_battery")->where("id=$id")->find();
        }
        $this->assign('res',$getBusRes);//赋值数据集
        $this->display();
    }
    public function operator_replytoyslist(){        
        $imgid = $_GET['id'];
        $album = M('toys_business'); 
        $find_where['id']=$imgid;
        $findRes=$album->where($find_where)->find();
        $root_img_id=$findRes['root_img_id'];
        if($root_img_id>0) {
           $find_img_id=$root_img_id;
        } else {
            $find_img_id=$imgid;
        }      
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/toysreplylist?id=$find_img_id");
    }
    //玩具出库状态
    public function getoutbusinessinfo(){
        $start_time=I('start_time');
        $end_time=I('end_time');
        $str_card_info=$this->getCardInfo();
        if($start_time) {
            $today=$start_time;
        } else {
            $today=date("Y-m-d 00:00:00",strtotime("-6 day"));
        }
        $this->assign("start_time",$today);
        if($end_time) {
            $moring=$end_time;
        } else {
            $moring=date("Y-m-d 00:00:00",strtotime("+1 day"));
        }
        $this->assign("end_time",$moring);
        $show_time=$today."到".$moring;
        $model = new Model();
        $begintime = strtotime($today);
        $endtime = strtotime($moring);
        for($start =$endtime ; $start >$begintime; $start -= 24 * 3600) {
            $show_start=date("Y-m-d H:i:s",strtotime("-1 day",$start) );
            $show_start2=date("Y-m-d H:i:s", $start );
            //玩具种类
            $toys_type_list = M('toys_business_listing')
                ->field('business_id')
                ->group("business_id")
                ->where("state='0' and create_time>'$show_start' and create_time<'$show_start2' and new_old='0' ")
                ->select();
            $toys_type_count=count($toys_type_list);

            //玩具个数
            $toys_number_list = M('toys_business_listing')
                ->field('id')
                ->where("state='0' and create_time>'$show_start' and create_time<'$show_start2' and new_old='0' ")
                ->select();
            $toys_number_count=count($toys_number_list);
            $toys_count=$toys_type_count."/".$toys_number_count;

            //入库
            $in_list = M('toys_order')
                ->field('id')
                ->where("state='0' and status=11 and post_create_time>'$show_start' and post_create_time<'$show_start2' and is_prize in (0,3) ")
                ->select();
            $in_count=count($in_list);
            $in_user_list = M('toys_order')
                ->field('user_id')
                ->group("user_id")
                ->where("state='0' and status=11 and post_create_time>'$show_start' and post_create_time<'$show_start2' and is_prize in (0,3) ")
                ->select();
            $in_user_count=count($in_user_list);
            $in_count_info=$in_count."/".$in_user_count;

            //取消送货
            $cancel_list = M('toys_order')
                ->field('id')
                ->where("state='0' and post_create_time>'$show_start' and post_create_time<'$show_start2' and is_prize in (0,3) and cancel_reason in (1,2,3) and status in (2,17,10) ")
                ->select();
            $cancel_count=count($cancel_list);
            $cancel_user_list = M('toys_order')
                ->field('user_id')
                ->group("user_id")
                ->where("state='0' and post_create_time>'$show_start' and post_create_time<'$show_start2' and is_prize in (0,3) and cancel_reason in (1,2,3) and status in (2,17,10) ")
                ->select();
            $cancel_user_count=count($cancel_user_list);
            $cancel_count_info=$cancel_count."/".$cancel_user_count;


            //送货中[送]
            $ordering_list =$model-> table('baby_toys_order as o')
                       ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.id')
                ->where("o.state='0' and o.status=5 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='5' and i.state='0' ")
                ->select();
            $ordering_count=count($ordering_list);
            $ordering_user_list =$model->table('baby_toys_order as o')
                       ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.user_id')
                ->group("o.user_id")
                ->where("o.state='0' and o.status=5 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='5' and i.state='0' ")
                ->select();
            $ordering_user_list_count=count($ordering_user_list);

            //送货中[取]
            $back_postid_list =$model->table('baby_toys_order as o')
                       ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.id')
                ->where("o.state='0' and o.status=10 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='7' and i.state='0' and i.postman_id>0 ")
                ->select();
            $back_postid_count=count($back_postid_list);
            $back_postid_user_list = $model->table('baby_toys_order as o')
                       ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.user_id')
                ->group("o.user_id")
                ->where("o.state='0' and o.status=10 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='7' and i.state='0' and i.postman_id>0 ")
                ->select();
            $back_postid_user_count=count($back_postid_user_list);

            $ordering_count_info=$ordering_count."—".$ordering_user_list_count."/".$back_postid_count."—".$back_postid_user_count;

            //玩乐中
            $fun_list = $model->table('baby_toys_order as o')
                ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.id')
                ->where("o.state='0' and o.status=6 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='8' and i.state='0' ")
                ->select();
            $fun_count=count($fun_list);
            $fun_user_list = $model->table('baby_toys_order as o')
                ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                ->field('o.user_id')
                ->group("o.user_id")
                ->where("o.state='0' and o.status=6 and o.is_prize in (0,3) and i.post_create_time>'$show_start' and i.post_create_time<'$show_start2' and i.status='8' and i.state='0' ")
                ->select();
            $fun_user_list_count=count($fun_user_list);
            $fun_count_info=$fun_count."/".$fun_user_list_count;

            //待派单[送]
            $send_list = M('toys_order')
                ->field('id')
                ->where("state='0' and status in (2,17) and business_id not in ($str_card_info) and toys_number<>'' and is_prize in (0,3) ")
                ->select();
            $send_count=count($send_list);
            $send_user_list = M('toys_order')
                ->field('user_id')
                ->group("user_id")
                ->where("state='0' and status in (2,17) and business_id not in ($str_card_info) and toys_number<>'' and is_prize in (0,3) ")
                ->select();
            $send_user_list_count=count($send_user_list);
            $send_count_info=$send_count."/".$send_user_list_count;


            //备货中
            $prepare_list = M('toys_order')
                ->field('id')
                ->where("state='0' and status=2 and business_id not in ($str_card_info) and ( (toys_number is null) or (toys_number='') ) and is_prize in (0,3) and create_time>'$show_start' and create_time<'$show_start2' ")
                ->select();
            $prepare_count=count($prepare_list);
            $prepare_user_list = M('toys_order')
                ->field('user_id')
                ->group("user_id")
                ->where("state='0' and status=2 and business_id not in ($str_card_info) and ( (toys_number is null) or (toys_number='') ) and is_prize in (0,3) and create_time>'$show_start' and create_time<'$show_start2' ")
                ->select();
            $prepare_user_list_count=count($prepare_user_list);
            $prepare_count_info=$prepare_count."/".$prepare_user_list_count;


            $res[]=array(
                'toys_count'=>$toys_count,//新玩具上架量（玩具种类/玩具个数）
                'in_count_info'=>$in_count_info,//入库量/用户量
                'cancel_count_info'=>$cancel_count_info,//取消送货量/用户量
                'fun_count_info'=>$fun_count_info,//玩乐中/用户量
                'ordering_count_info'=>$ordering_count_info,//送货中[送/取]
                'prepare_count_info'=>$prepare_count_info,//准备中数量/用户量
                'send_count_info'=>$send_count_info,//待出库数量/用户量
                'start_time'=>$show_start,
                'end_time'=>$show_start2,
                'times'=>$show_start."<br/>".$show_start2
            );
        }
        $this->assign("show_time",$show_time);
        $this->assign("res",$res);
        $this->display();
    }

    public function getoutbusinessinfo1114(){
        $start_time=I('start_time');
        $end_time=I('end_time');
        $str_card_info=$this->getCardInfo();
        if($start_time) {
            $today=$start_time;
            $this->assign("start_time",$start_time);
        } else {
            $today=date("Y-m-d 00:00:00");
        }
        if($end_time) {
            $moring=$end_time;
            $this->assign("end_time",$end_time);
        } else {
            $moring=date("Y-m-d 00:00:00",strtotime("+1 day"));
        }
        $show_time=$today."到".$moring;
        //玩具种类
        $toys_type_list = M('toys_business')
            ->field('id')
            ->where("state='0' and root_img_id=0 and create_time>'$today' and create_time<'$moring' and is_card=0 ")
            ->select();
        $toys_type_count=count($toys_type_list);

        //玩具个数
        $toys_number_list = M('toys_business_listing')
            ->field('id')
            ->where("state='0' and is_use=0 and post_create_time>'$today' and post_create_time<'$moring' ")
            ->select();
        $toys_number_count=count($toys_number_list);

        $out_toys_number_list = M('toys_business_listing')
            ->field('id')
            ->where("state='0' and is_use=0 and post_create_time>'$today' and post_create_time<'$moring' and out_state='1' ")
            ->select();
        $out_toys_number_count=count($out_toys_number_list);//出库

        $in_toys_number_list = M('toys_business_listing')
            ->field('id')
            ->where("state='0' and is_use=0 and post_create_time>'$today' and post_create_time<'$moring' and out_state='0' ")
            ->select();
        $in_toys_number_count=count($in_toys_number_list);//未出库


        //入库
        $in_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=11 and post_create_time>'$today' and post_create_time<'$moring' and is_prize=0 ")
            ->select();
        $in_count=count($in_list);
        $in_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=11 and post_create_time>'$today' and post_create_time<'$moring' and is_prize=0 ")
            ->select();
        $in_user_count=count($in_user_list);
        $in_count_info=$in_count."【玩具】—".$in_user_count."【用户】";

        //待取回
        $back_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=10 and is_prize=0 ")
            ->select();
        $back_count=count($back_list);
        $back_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=10 and is_prize=0 ")
            ->select();
        $back_user_count=count($back_user_list);
        $back_count_info=$back_count."【玩具】—".$back_user_count."【用户】";

        //已取回
        $aready_back_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=7 and post_create_time>'$today' and post_create_time<'$moring' and business_id not in ($str_card_info) and is_prize=0 ")
            ->select();
        $aready_back_count=count($aready_back_list);
        $aready_back_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=7 and post_create_time>'$today' and post_create_time<'$moring' and business_id not in ($str_card_info) and is_prize=0 ")
            ->select();
        $aready_back_user_list_count=count($aready_back_user_list);
        $aready_back_count_info=$aready_back_count."【玩具】—".$aready_back_user_list_count."【用户】";

        //玩乐中
        $fun_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=6 and post_create_time>'$today' and post_create_time<'$moring' and is_prize=0 ")
            ->select();
        $fun_count=count($fun_list);
        $fun_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=6 and post_create_time>'$today' and post_create_time<'$moring' and is_prize=0 ")
            ->select();
        $fun_user_list_count=count($fun_user_list);
        $fun_count_info=$fun_count."【玩具】—".$fun_user_list_count."【用户】";

        //送货中[送]
        $ordering_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=5 and is_prize=0  ")
            ->select();
        $ordering_count=count($ordering_list);
        $ordering_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=5 and is_prize=0 ")
            ->select();
        $ordering_user_list_count=count($ordering_user_list);
        $ordering_count_info=$ordering_count."【玩具】—".$ordering_user_list_count."【用户】";

        //待派单[送]
        $send_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=2 and business_id not in ($str_card_info) and toys_number<>'' and is_prize=0 ")
            ->select();
        $send_count=count($send_list);
        $send_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=2 and business_id not in ($str_card_info) and toys_number<>'' and is_prize=0 ")
            ->select();
        $send_user_list_count=count($send_user_list);
        $send_count_info=$send_count."【玩具】—".$send_user_list_count."【用户】";

        //备货中
        $prepare_list = M('toys_order')
            ->field('id')
            ->where("state='0' and status=2 and business_id not in ($str_card_info) and ( (toys_number is null) or (toys_number='') ) and is_prize=0 ")
            ->select();
        $prepare_count=count($prepare_list);
        $prepare_user_list = M('toys_order')
            ->field('user_id')
            ->group("user_id")
            ->where("state='0' and status=2 and business_id not in ($str_card_info) and ( (toys_number is null) or (toys_number='') ) and is_prize=0 ")
            ->select();
        $prepare_user_list_count=count($prepare_user_list);
        $prepare_count_info=$prepare_count."【玩具】—".$prepare_user_list_count."【用户】";

        $res=array(
            'in_count'=>$in_count_info,//入库
            'prepare_count'=>$prepare_count_info,//备货中
            'send_count'=>$send_count_info,//待派单[送]
            'ordering_count'=>$ordering_count_info,//送货中[送]
            'fun_count'=>$fun_count_info,//玩乐中
            'back_count'=>$back_count_info,//待取回
            'aready_back_count'=>$aready_back_count_info,//已取回
            'toys_type_count'=>$toys_type_count,//玩具种类
            'toys_number_count'=>$toys_number_count,//玩具个数
            'show_time'=>$show_time,
            'out_toys_number_count'=>$out_toys_number_count,
            'in_toys_number_count'=>$in_toys_number_count
        );
        $this->assign("res",$res);
        $this->display();
    }
    //玩具数量
    public function getpostmanlist(){
        $today=I('start_time');
        $moring=I('end_time');
        $order_status=I('order_status');//1:送货中数量/待取回数量（配送员接单）、2取消送货量、3入库量、4新玩具上架量
        $str_card_info=$this->getCardInfo();
        $show_time=$today."到".$moring;
        $model = new Model();
        if($order_status==1) {//送货中[送和取]
            $where_condition="o.state='0' and o.is_prize in (0,3) and i.post_create_time>'$today' and i.post_create_time<'$moring' and i.state='0' and i.postman_id>0 and ((i.status='5' and o.status=5) or (i.status='7' and o.status=10 ) )";
            $resultRes =$model-> table('baby_toys_order as o')
                    ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                    ->field('count(o.id) as count,i.postman_id')
                    ->group("i.postman_id")
                    ->where($where_condition)
                    ->select();
            $status_name="配送员送和取";
        } elseif($order_status==2) {//取消送货量
            $where_condition="o.state='0' and o.post_create_time>'$today' and o.post_create_time<'$moring' and o.is_prize in (0,3) and o.cancel_reason in (1,2,3) and ((i.status='2' and o.status in (2,17) ) or (i.status='7' and o.status=10 ) ) ";
            $resultRes =$model-> table('baby_toys_order as o')
                    ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                    ->field('count(o.id) as count,i.postman_id')
                    ->group("i.postman_id")
                    ->where($where_condition)
                    ->select();
            $status_name="取消送货量";
        } elseif($order_status==3) {//入库量
            $where_condition="o.state='0' and o.post_create_time>'$today' and o.post_create_time<'$moring' and o.is_prize in (0,3) and i.status='11' and o.status=11 ";
            $resultRes =$model-> table('baby_toys_order as o')
                    ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                    ->field('count(o.id) as count,i.postman_id')
                    ->group("i.postman_id")
                    ->where($where_condition)
                    ->select();
            $status_name="入库量";
        } elseif($order_status==4) {//新玩具上架量
            $status_name="新玩具上架量";
            $toys_condition="state='0' and create_time>'$today' and create_time<'$moring' and new_old='0' ";
            //玩具种类
            $toys_type_list = M('toys_business_listing')
                    ->field('business_id')
                    ->group("business_id")
                    ->where($toys_condition)
                    ->select();

        }
        $res=array();
        if($resultRes) {//订单相关
            foreach ($resultRes as $key => $value) {
                $order_count=$value['count'];
                $postman_id=$value['postman_id'];
                if($postman_id>0) {
                    $getuserinfo=M("user")->field('user_name')->where("id=$postman_id")->find();
                    $real_name=$getuserinfo['user_name']?$getuserinfo['user_name']:"";
                } else {
                    $real_name="";
                }
                $userRes =$model-> table('baby_toys_order as o')
                    ->join(" left join baby_toys_listing as i on i.order_id=o.id")
                    ->field('o.user_id')
                    ->group("o.user_id")
                    ->where($where_condition." and i.postman_id=$postman_id ")
                    ->select();
                $user_count=count($userRes);
                $res[]=array(
                    'postman_id'=>$postman_id,
                    'order_count'=>$order_count,
                    'real_name'=>$real_name,
                    'user_count'=>$user_count,
                    'show_time'=>$show_time
                );
            }
        }
        if($toys_type_list) {//玩具相关
            foreach ($toys_type_list as $key => $value) {
                $business_id=$value['business_id'];
                $toys_count = M('toys_business_listing')
                    ->where($toys_condition." and business_id=$business_id ")
                    ->count();
                $toys_title_res = M('toys_business')
                    ->field('business_title')
                    ->where(" id=$business_id ")
                    ->find();
                $business_title=$toys_title_res['business_title'];
                $toys_res[]=array(
                    'business_id'=>$business_id,
                    'business_title'=>$business_title,
                    'toys_count'=>$toys_count,
                    'show_time'=>$show_time
                );
            }
        }
        $this->assign("start_time",$today);
        $this->assign("end_time",$moring);
        $this->assign("order_status",$order_status);
        $this->assign("status_name",$status_name);
        $this->assign("res",$res);
        $this->assign("toys_res",$toys_res);
        $this->display();
    }
    
    //预约玩具列表
    public function getappointmentlist() {
        $search_user_id=I("search_user_id");
        $search_business_id=I("search_business_id");
        $search_toys_title=I("search_toys_title");
        $search_is_rent=I("search_is_rent");
        $search_number=I("search_number");
        $search_type=I("search_type");//0默认、1玩具种类
        $excel_state=I("excel_state");
        if($excel_state==1) {
            $search_type=1;
        }
        if($search_is_rent<1) {
            $search_is_rent=2;
        }
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="a.state='0' ";
        if($search_type>0) {
            $this->assign('search_type',$search_type);
        }
        if($search_user_id>0) {
            $where2.=" and a.user_id='$search_user_id' ";
            $this->assign('search_user_id',$search_user_id);
        }
        if($search_is_rent>0) {
            $where2.=" and a.is_rent='$search_is_rent' ";
            $this->assign('search_is_rent',$search_is_rent);
        }
        if($search_toys_title) {
            $where2.=" and ( (a.toys_title like '%$search_toys_title%') or (b.key_words like '%$search_toys_title%') or (b.business_brand like '%$search_toys_title%') ) ";
            $this->assign('search_toys_title',$search_toys_title);
        }
        //有库存检查 开始
        $getNumRes= M('toys_appointment')
                    ->field("business_id")
                    ->group("business_id ")
                    ->where("business_id>0")
                    ->select();
        $arr_business_id=array();
        if($getNumRes) {
            foreach ($getNumRes as $key => $value) {
                $business_id=$value['business_id'];
                $getBusinessRes=$this->getBusinessTotalNum($business_id);
                $toys_number=$getBusinessRes['use_count'];
                if($toys_number>0) {
                    $arr_business_id[]=$business_id;
                }
            }
        }
        if($search_number==1) {
            $this->assign('search_number',$search_number);
        }
        if($search_business_id>0) {
            $where2.=" and a.business_id='$search_business_id' ";
            $this->assign('search_business_id',$search_business_id);
        } elseif(($search_number==1) && ($arr_business_id) ) {
            $str_business_id=implode(",", $arr_business_id);
            $where2.=" and a.business_id in ($str_business_id) ";
        }
        //有库存检查 结束
        $model = new Model();
        if($search_type==1) {
            if($excel_state==1) {//导出
                $getexcelUserRes= $model->table('baby_toys_appointment as a')
                        ->field("a.toys_title,a.business_id")
                        ->join(" left join tmp_toys_app01 as app on app.business_id=a.business_id and a.business_id>0 ")
                        ->where($where2)
                        ->group("a.business_id ")
                        ->order("app.user_count desc ")
                        ->select();
                $xlsData=array();
                if($getexcelUserRes) {
                    $xlsName="预约玩具";
                    $xlsCell  = array(
                        array('toys_info','预约玩具信息')
                    );
                    foreach ($getexcelUserRes as $key => $value) {
                        $toys_title=$value['toys_title'];
                        $business_id=$value['business_id'];
                        if($business_id>0) {
                            $bus_count  = M('toys_appointment')
                                ->where("state='0' and business_id=$business_id and is_rent in (2,4) ")
                                ->count();
                            $toys_info=$business_id."\n".$toys_title."\n预约".$bus_count."人";
                        } else {
                            $toys_info=$toys_title;
                        }
                        $xlsData[]=array(
                            'toys_info'=>$toys_info
                        );
                    }
                    $this->exportExcel($xlsName,$xlsCell,$xlsData);
                }
            }

            //满足条件的总记录数
            $buscount= $model->table('baby_toys_appointment as a')
                            ->join(" left join baby_user as u on a.user_id=u.id")
                            ->join(" left join baby_toys_business as b on a.business_id=b.id")
                            ->join(" left join tmp_toys_app01 as app on app.business_id=a.business_id and a.business_id>0 ")
                            ->field("a.business_id")
                            ->where($where2)
                            ->group("a.business_id ")
                            ->select();
            $count=count($buscount);
            $page = new  Page($count,50);//实例化分页类，传入总记录数
            $show = $page->show(); //分页显示输出
            $getListRes= $model->table('baby_toys_appointment as a')
                        ->join(" left join baby_user as u on a.user_id=u.id")
                        ->join(" left join baby_toys_business as b on a.business_id=b.id")
                        ->field("a.*,u.nick_name,u.mobile,case when a.is_rent in (1,3) then 1 else 2 end rent_rank")
                        ->join(" left join tmp_toys_app01 as app on app.business_id=a.business_id and a.business_id>0 ")
                        ->where($where2)
                        ->group("a.business_id ")
                        ->order("app.user_count desc ")
                        ->limit($page->firstRow,$page->listRows)
                        ->select();
        } else {
            //满足条件的总记录数
            $count= $model->table('baby_toys_appointment as a')
                            ->join(" left join baby_user as u on a.user_id=u.id")
                            ->join(" left join baby_toys_business as b on a.business_id=b.id")
                            ->where($where2)
                            ->count();
            $page = new  Page($count,50);//实例化分页类，传入总记录数
            $show = $page->show(); //分页显示输出
            $getListRes= $model->table('baby_toys_appointment as a')
                        ->join(" left join baby_user as u on a.user_id=u.id")
                        ->join(" left join baby_toys_business as b on a.business_id=b.id")
                        ->field("a.*,u.nick_name,u.mobile,b.is_show,case when a.is_rent in (1,3) then 1 else 2 end rent_rank")
                        ->where($where2)
                        ->order("rent_rank desc,a.create_time desc")
                        ->limit($page->firstRow,$page->listRows)
                        ->select();
        }
        $res=array();
        if($getListRes) {
            foreach ($getListRes as $key => $value) {
                $create_time=$value['create_time'];
                $post_create_time=$value['post_create_time'];
                $show_time=$create_time."<br/>".$post_create_time;
                $user_id=$value['user_id'];
                $nick_name=$value['nick_name'];
                $mobile=$value['mobile'];
                $business_id=$value['business_id'];
                $toys_title=$value['toys_title'];
                $is_rent=$value['is_rent'];
                $public_name=$value['public_name'];
                $remark=$value['remark'];
                $id=$value['id'];
                $is_show = $value['is_show'];
                if($is_show==2){
                    $toys_title .= "(已下架)";
                }else
                if($is_rent==1) {
                    $rent_title="已租";
                } elseif($is_rent==5) {
                    $rent_title="已通知";
                } elseif($is_rent==4) {
                    $rent_title="重新排队";
                } elseif($is_rent==3) {
                    $rent_title="放弃";
                } elseif($is_rent==6) {
                    $rent_title="处理中";
                } else {
                    $rent_title="未租";
                }
                $user_info=$toys_info="";
                $user_info=$user_id;
                if($nick_name) {
                    $user_info.="<br/>".$nick_name ;
                }
                if($mobile) {
                    $user_info.="<br/>".$mobile ;
                }
                if($business_id>0) {
                    //排序计算 开始
                    if(($is_rent==2) ) {
                        $rank_count= M('toys_appointment')
                        ->where("state='0' and business_id=$business_id and is_rent in (2) and create_time<'$create_time' ")
                        ->count();
                        $show_rank=$rank_count+1;
                    } else {
                        $show_rank="";
                    }
                    //排序计算 结束
                    $getBusinessRes=$this->getBusinessTotalNum($business_id);
                    $toys_number=$getBusinessRes['use_count'];
                    if($toys_number<=0) {
                        $toys_number=0;
                    }

                    $bus_count  = M('toys_appointment')
                        ->where("state='0' and business_id=$business_id and is_rent in (2,4) ")
                        ->count();
                    $toys_info=$business_id."<br/>".$toys_title."<br/>预约".$bus_count."人";
                } else {
                    $toys_info=$toys_title;
                    $toys_number=0;
                }
                $res[]=array(
                    'user_id'=>$user_id,
                    'user_info'=>$user_info,
                    'toys_info'=>$toys_info,
                    'id'=>$id,
                    'rent_title'=>$rent_title,
                    'create_time'=>$show_time,
                    'public_name'=>$public_name,
                    'toys_number'=>$toys_number,
                    'show_rank'=>$show_rank,
                    'remark'=>$remark
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除预约玩具
    public function operator_appointmentstate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_appointment');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getappointmentlist.html");
    }

    //预约玩具操作页面
    public function pubappointment() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_appointment")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //仓库记录列表
    public function getwarehouserelist() {
        $search_user_id=I("search_user_id");
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="a.state='0' ";
        if($search_user_id>0) {
            $where2.=" and a.user_id='$search_user_id' ";
            $this->assign('search_user_id',$search_user_id);
        }
        $model = new Model();
        //满足条件的总记录数
        $count  = $model->table('baby_toys_warehouse_remember as a')
                        ->join(" left join baby_user as u on a.user_id=u.id")
                        ->where($where2)
                        ->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getListRes= $model->table('baby_toys_warehouse_remember as a')
                    ->join(" left join baby_user as u on a.user_id=u.id")
                    ->field("a.*,u.nick_name,u.mobile")
                    ->where($where2)
                    ->order("id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getListRes) {
            foreach ($getListRes as $key => $value) {
                $create_time=$value['create_time'];
                $user_id=$value['user_id'];
                $nick_name=$value['nick_name'];
                $mobile=$value['mobile'];
                $problem=$value['problem'];
                $need_problem=$value['need_problem'];
                $handle_record=$value['handle_record'];
                $id=$value['id'];
                $user_info=$toys_info="";
                $user_info=$user_id;
                if($nick_name) {
                    $user_info.="<br/>".$nick_name ;
                }
                if($mobile) {
                    $user_info.="<br/>".$mobile ;
                }
                $res[]=array(
                    'user_info'=>$user_info,
                    'problem'=>$problem,
                    'id'=>$id,
                    'need_problem'=>$need_problem,
                    'handle_record'=>$handle_record,
                    'create_time'=>$create_time
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除仓库记录
    public function operator_warehouserestate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_warehouse_remember');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getwarehouserelist.html");
    }

    //仓库记录操作页面
    public function pubwarehousere() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_warehouse_remember")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }

    //停卡列表
    public function getstopcardlist() {
        $search_user_id=I("search_user_id");
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="a.state='0' and a.status=4 ";
        if($search_user_id>0) {
            $where2.=" and a.user_id='$search_user_id' ";
            $this->assign('search_user_id',$search_user_id);
        }
        $model = new Model();
        //满足条件的总记录数
        $count  = $model->table('baby_toys_card as a')
                        ->join(" left join baby_user as u on a.user_id=u.id")
                        ->where($where2)
                        ->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getListRes= $model->table('baby_toys_card as a')
                    ->join(" left join baby_user as u on a.user_id=u.id")
                    ->field("a.*,u.nick_name,u.mobile")
                    ->where($where2)
                    ->order("a.id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getListRes) {
            foreach ($getListRes as $key => $value) {
                $create_time=$value['create_time'];
                $end_time=$value['end_time'];
                $final_end_time=$value['final_end_time'];
                if($final_end_time!="0000-00-00 00:00:00") {
                    $show_time=$final_end_time."<br/>".$create_time;
                } else {
                    $show_time=$end_time."<br/>".$create_time;
                }
                $user_id=$value['user_id'];
                $nick_name=$value['nick_name'];
                $mobile=$value['mobile'];
                $status=$value['status'];
                if($status==4) {
                    $status_name="停卡";
                } else {
                    $status_name="正常使用";
                }
                $id=$value['id'];
                $user_info=$toys_info="";
                $user_info=$user_id;
                if($nick_name) {
                    $user_info.="<br/>".$nick_name ;
                }
                if($mobile) {
                    $user_info.="<br/>".$mobile ;
                }
                $res[]=array(
                    'user_info'=>$user_info,
                    'id'=>$id,
                    'status_name'=>$status_name,
                    'show_time'=>$show_time
                );
            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }
    //停卡操作页面
    public function pubstopcard() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_card")
                        ->where("id=$id and state='0' and status='4' ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //客服交接列表
    public function getcusplolist() {
        $search_user_id=I("search_user_id");
        $search_problem=I("search_problem");
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="state='0' ";
        /*if($search_user_id>0) {
            $where2.=" and problem like '%$search_user_id%' ";
            $this->assign('search_user_id',$search_user_id);
        }*/
        if($search_problem) {
        	$where2.=" and problem like '%$search_problem%' ";
            $this->assign('search_problem',$search_problem);
        }
        $model = new Model();
        //满足条件的总记录数
        $user_count  = $model->table('baby_toys_customer_problem')
                        ->where($where2)
                        ->select();
        $count=count($user_count);
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getUserRes= $model->table('baby_toys_customer_problem')
                    ->where($where2)
                    ->order("id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getUserRes) {
            foreach ($getUserRes as $key => $value) {
                $create_time=$value['create_time'];
                $problem=$value['problem'];
                $handle_record=$value['handle_record'];
                $public_name=$value['public_name'];
                $id=$value['id'];
                $res[]=array(
                    'problem'=>$problem,
                    'handle_record'=>$handle_record,
                    'id'=>$id,
                    'create_time'=>$create_time,
                    'public_name'=>$public_name
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除客服交接
    public function operator_cusplostate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_customer_problem');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getcusplolist.html");
    }
    //客服交接操作页面
    public function pubcusplo() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_customer_problem")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //采购列表
    public function getbuspurlist() {
        $search_id=I("search_id");
        $search_business_id=I("search_business_id");
        $start_time=I('start_time');
        $end_time=I('end_time');
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="a.state='0' ";
        if($search_id>0) {
            $where2.=" and a.id='$search_id' ";
            $this->assign('search_business_id',$search_business_id);
        }
        if($search_business_id>0) {
            $where2.=" and a.business_id='$search_business_id' ";
            $this->assign('search_business_id',$search_business_id);
        }
        if($start_time) {
            $where2.=" and a.purchase_time>'$start_time' ";
            $this->assign("start_time",$start_time);
        }
        if($end_time) {
            $where2.=" and a.purchase_time<'$end_time' ";
            $this->assign("end_time",$end_time);
        }
        $model = new Model();
        //满足条件的总记录数
        $count= $model->table('baby_toys_business_purchasing as a')
                        ->where($where2)
                        ->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getListRes= $model->table('baby_toys_business_purchasing as a')
                    ->where($where2)
                    ->order("a.id desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getListRes) {
            foreach ($getListRes as $key => $value) {
                $id=$value['id'];
                $business_id=$value['business_id'];
                $price=$value['price']?$value['price']:0;
                $total_number=$value['total_number']?$value['total_number']:0;
                $mobile=$value['mobile'];
                $source=$value['source'];
                $purchase_time=$value['purchase_time'];
                $post_url=$value['post_url'];
                $toys_info="";
                if($business_id>0) {
                    
                    $busRes=M('toys_business')
                        ->field('business_title')
                        ->where("state='0' and id=$business_id  ")
                        ->find();
                    $toys_title=$busRes['business_title'];
                    $toys_info=$business_id."<br/>".$toys_title;
                }
                $res[]=array(
                    'id'=>$id,
                    'business_id'=>$business_id,
                    'toys_info'=>$toys_info,
                    'price'=>$price,
                    'total_number'=>$total_number,
                    'mobile'=>$mobile,
                    'source'=>$source,
                    'purchase_time'=>$purchase_time,
                    'post_url'=>$post_url
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除采购
    public function operator_buspurstate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_business_purchasing');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getbuspurlist.html");
    }

    //采购操作页面
    public function pubbuspur() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_business_purchasing")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //奖品订单列表
    public function getorderprizelist(){
        $this->checkSession();  
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="o.is_prize='1' ";
        $model = new Model();
        $order_status=trim(I("order_status"));
        if($order_status) {
            $where2.=" and o.status=$order_status ";
            if($order_status!=11) {
                $where2.=" and o.state='0'  ";
            }
            $this->assign('order_status',$order_status);
        } else {
            $where2.=" and o.state='0' ";
        }
        $order_id=trim(I("order_id"));
        if($order_id) {
            $where2.=" and o.id=$order_id ";
            $this->assign('order_id',$order_id);
        }
        $business_id=trim(I("business_id"));
        if($business_id) {
            $where2.=" and o.business_id=$business_id  ";
            $this->assign('business_id',$business_id);
        }
        $user_id=trim(I("user_id"));
        if($user_id) {
            $where2.=" and o.user_id=$user_id ";
            $this->assign('user_id',$user_id);
        }
        //满足条件的总记录数
        $count  = $model->table('baby_toys_order as o')
                        ->join(" left join baby_toys_prize as b on o.business_id=b.id")
                        ->join(" left join baby_user as u on o.user_id=u.id")
                        ->where($where2)
                        ->count();
        $page = new  Page($count,30);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $res=array();
        $listres = $model->table('baby_toys_order as o')
                    ->join(" left join baby_toys_prize as b on o.business_id=b.id")
                    ->join(" left join baby_user as u on o.user_id=u.id")
                    ->where($where2)
                    ->field('o.id,o.order_num,o.combined_order_id,o.post_create_time,o.create_time,o.user_id,u.nick_name,u.mobile,o.business_id,b.prize_title2 as business_title,o.status,b.img')
                    ->order('o.post_create_time desc')
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        foreach ($listres as $key => $value) {
            $order_id=$value['id'];
            $order_num=$value['order_num'];
            $combined_order_id=$value['combined_order_id'];
            $tmp_post_create_time=$value['post_create_time'];
            $create_time=$value['create_time'];
            $tmp_user_id=$value['user_id'];
            $nick_name=$value['nick_name'];
            $mobile=$value['mobile'];
            $tmp_business_id=$value['business_id'];
            $business_title=$value['business_title'];
            $tmp_status=$value['status'];
            $tmp_img="http://api.meimei.yihaoss.top/".$value['img'];
            $user_info="";
            $user_info=$tmp_user_id;
            if($nick_name) {
                $user_info.="<br/>".$nick_name;
            }
            if($mobile) {
                $user_info.="<br/>".$mobile;
            }
            if($tmp_status==2) {
                $status_name="准备中";
            } elseif($tmp_status==5) {
                $status_name="送货中";
            } elseif($tmp_status==11) {
                $status_name="已送达";
            } else {
                $status_name="";
            }
            $order_info=$order_id."<br/>".$order_num."<br/>".$combined_order_id;
            $prize_info=$tmp_business_id."<br/>".$business_title;
            $show_time=$tmp_post_create_time."<br/>".$create_time;
            $res[]=array(
                'id'=>$order_id,
                'user_info'=>$user_info,
                'status_name'=>$status_name,
                'order_info'=>$order_info,
                'prize_info'=>$prize_info,
                'show_time'=>$show_time,
                'img'=>$tmp_img
            );
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();   
    }
    //删除奖品订单
    public function operator_prizeorderstate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_order');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/getorderprizelist.html");
    }
    //添加奖品订单页面
    public function pubtoysprize(){
        $top_label=M("toys_prize")
                ->field('id,prize_title2 as prize_title,img')
                ->where("state='0' ")
                ->select();
        $this->assign('top_label',$top_label);
        $this->display();
    }
    //热门搜索列表
    public function gethotsearchlist() {
        $this->checkSession(); 
        import("ORG.Util.Page");
        import("ORG.Alipay.Page");
        $where2="a.state='0' ";
        
        $model = new Model();
        //满足条件的总记录数
        $count= $model->table('baby_toys_business_hot_search as a')
                        ->where($where2)
                        ->count();
        $page = new  Page($count,50);//实例化分页类，传入总记录数
        $show = $page->show(); //分页显示输出
        $getListRes= $model->table('baby_toys_business_hot_search as a')
                    ->where($where2)
                    ->order("a.rank desc,a.post_create_time desc ")
                    ->limit($page->firstRow,$page->listRows)
                    ->select();
        $res=array();
        if($getListRes) {
            foreach ($getListRes as $key => $value) {
                $id=$value['id'];
                $search_title=$value['search_title'];
                $rank=$value['rank'];
                $res[]=array(
                    'rank'=>$rank,
                    'search_title'=>$search_title,
                    'id'=>$id
                );

            }
        }
        $this->assign('res',$res);//赋值数据集
        $this->assign('page',$show);//赋值分页输出
        $this->display();
    }

    //删除热门搜索
    public function operator_hotsearchstate(){        
        $imgid = $_GET['imgid'];
        $album = M('toys_business_hot_search');
        $where['id'] = array('in',$imgid);
        $data['state'] = '1' ;
        $result = $album->where($where)->data($data)->save();
        header("Location:http://checkpic.meimei.yihaoss.top/Toys/gethotsearchlist.html");
    }

    //热门搜索操作页面
    public function pubhotsearch() { 
        $id=I("id");
        if($id>0) {
            $getUserRes= M("toys_business_hot_search")
                        ->where("id=$id ")
                        ->find();
        }
        $this->assign('res',$getUserRes);
        $this->display();
    }
    //玩具赔付页面
    public function toyspayment(){
        $this->display();
    }

}
?>
